# Draytek_v3910è§£å¯†CN/English version at the bottom

### 1ã€å·²çŸ¥æ˜¯archh64ä¸ºçš„

#### âœ… ç®€è¦è¯´æ˜ï¼š

- **å‚å•†**ï¼šCaviumï¼ˆåæ¥è¢« Marvell æ”¶è´­ï¼‰
- **æ¶æ„**ï¼šARMv8-Aï¼ˆå…¼å®¹ aarch64 æŒ‡ä»¤é›†ï¼‰
- **ç”¨é€”**ï¼šé«˜æ€§èƒ½åµŒå…¥å¼ç³»ç»Ÿã€ç½‘ç»œå®‰å…¨è®¾å¤‡ã€ä¼ä¸šè·¯ç”±å™¨ã€æ•°æ®ä¸­å¿ƒæœåŠ¡å™¨ã€‚
- **å¸¸è§å‹å·**ï¼š
  - ThunderXï¼ˆç¬¬ä¸€ä»£ï¼‰
  - ThunderX2ï¼ˆæ”¹è¿›æ€§èƒ½ã€æ”¯æŒæ›´å¤šæ ¸ï¼‰
  - ThunderX3ï¼ˆå¤šè¾¾ 96 æ ¸ï¼‰

### 2ã€æ ¹æ®å·²çŸ¥ä¿¡æ¯æˆ‘ä»¬å¯ä»¥å…ˆæŠŠv3910_3971.allä¸¢å…¥IDAæŸ¥çœ‹HEX

![](/Image/img_v3910/3901-1.png)

![](/Image/img_v3910/3910-3.png)

![](/Image/img_v3910/3910-4.png)

### 3ã€åæ¨éªŒè¯ã€‚ä½¿ç”¨grep

~~~apl
# b:æ‰“å°åç§» o:æ‰“å°åŒ¹é… a:å°†äºŒè¿›åˆ¶å½“æ–‡æœ¬å¤„ç†
grep -boa $'\x54\x48\x55\x4E\x44\x45\x52\x58' v3910_3971.all 
#  131168:THUNDERX    å›æ˜¾  æŠŠåè¿›åˆ¶æ¢ç®—ä¸º 16 è¿›åˆ¶åå¾—åˆ°  boot.bin
#  327776:THUNDERX    å›æ˜¾  æŠŠåè¿›åˆ¶æ¢ç®—ä¸º 16 è¿›åˆ¶åå¾—åˆ°  æ— ç”¨
#  1600608:THUNDERX   å›æ˜¾  æŠŠåè¿›åˆ¶æ¢ç®—ä¸º 16 è¿›åˆ¶åå¾—åˆ°  init.bin
#  4194400:THUNDERX   å›æ˜¾  æŠŠåè¿›åˆ¶æ¢ç®—ä¸º 16 è¿›åˆ¶åå¾—åˆ°  ATF stage1
#  5160445:THUNDERX   å›æ˜¾  æŠŠåè¿›åˆ¶æ¢ç®—ä¸º 16 è¿›åˆ¶åå¾—åˆ°	æ— ç”¨
~~~



### 4ã€ä½¿ç”¨ddæå–

~~~apl
dd if=v3910_3971.all bs=1 skip=4194400 of=stage_1.bin  # å¾—åˆ°äº†äºŒè¿›åˆ¶æ–‡ä»¶
#  ä¸¢å…¥IDAåˆ†æHEX
~~~

### 5ã€äº†è§£åŸºç¡€ä¿¡æ¯

~~~apl
ATF å„æ˜ åƒå…¸å‹å†…å®¹ä¸ FIPï¼ˆé•œåƒæ‰“åŒ…ï¼‰

BL1ï¼šROM/early initï¼Œæç®€ï¼›é€šå¸¸ä¸æ˜¯ TF-A æºæ ‘é‡Œçš„äºŒè¿›åˆ¶ï¼ˆç”±å¹³å°æä¾›ï¼‰ã€‚

BL2ï¼ˆTF-A optional or platform BL2ï¼‰ï¼šè´Ÿè´£åŠ è½½ BL31/BL32/BL33ã€‚

BL31ï¼šEL3 runtimeï¼ˆTF-A æ ¸å¿ƒï¼‰ï¼Œtf-a çš„ bl31.elfã€‚

BL32ï¼šTEE (OP-TEE) çš„ tee.binã€‚

BL33ï¼šNon-secure bootloader (U-Boot) æˆ– kernelã€‚

FIPï¼šfip.bin åŒ…å«å¤šæ®µï¼ˆBL2/BL31/BL32/BL33ï¼‰ï¼Œé€šå¸¸æœ‰è¡¨å¤´ä¸ç­¾åã€‚
~~~

#### æµç¨‹å›¾

~~~apl
POWER/RESET
   |
   v
+--------------------------------+
| ROM / BootROM (on-chip ROM)    |
| - minimal loader               |
| - may verify BL1/BL2 signature |
+--------------------------------+
   æ³¨ï¼šèŠ¯ç‰‡ä¸Šç”µåæœ€å…ˆæ‰§è¡Œçš„åªè¯»å¼•å¯¼ä»£ç ï¼ˆMask ROM / BootROMï¼‰ã€‚
        - æå°ä»£ç ï¼šæ—©æœŸç¡¬ä»¶åˆå§‹åŒ–ï¼ˆæ—¶é’Ÿã€å¤ä½ï¼‰ã€é€‰æ‹©å¯åŠ¨ä»‹è´¨ã€‚
        - å¯èƒ½å®ç° Root-of-Trustï¼šæ ¡éªŒä¸‹ä¸€çº§ï¼ˆBL1/BL2/FIPï¼‰ç­¾åï¼Œå†³å®šæ˜¯å¦ä¿¡ä»»åç»­å›ºä»¶ã€‚
        - è°ƒè¯•ç‚¹ï¼šä¸²å£æ—©æœŸè¾“å‡ºã€BootROM æŠ¥é”™ä¿¡æ¯ã€ROM æ—¥å¿—ï¼ˆè‹¥æœ‰ï¼‰ã€‚
   |
   v
+--------------------------------+
| BL1 (Stage1)                   |
| - early debug UART             |
| - minimal clocks, DRAM init    |
| - load BL2 or FIP to DRAM      |
| - verify signatures (secure)   |
+--------------------------------+
   æ³¨ï¼šç¬¬ä¸€é˜¶æ®µå¼•å¯¼ï¼ˆé€šå¸¸å°è€Œå¯ä¿¡ï¼‰ï¼ŒæŠŠ BL2 æˆ– FIP è½½å…¥åˆ° DRAMã€‚
        - åŠŸèƒ½ï¼šåˆå§‹åŒ– UART ç”¨äºä¸²å£æ‰“å°ã€æœ€ä½é™åº¦çš„æ—¶é’Ÿä¸ DDR æ§åˆ¶å™¨åˆå§‹åŒ–ã€‚
        - å¯èƒ½è¿›è¡Œç­¾åéªŒè¯ï¼ˆextended secure boot chainï¼‰ã€‚
        - handoffï¼šæŠŠ BL2/FIP çš„å†…å­˜åœ°å€/å¤§å°ä¼ ç»™ BL2 å¹¶è·³è½¬ã€‚
        - è°ƒè¯•ç‚¹ï¼šä¸²å£çš„ early boot æ¶ˆæ¯ã€DRAM åˆå§‹åŒ–å¤±è´¥ä¿¡æ¯ã€‚
   |
   v
+--------------------------------+
| BL2 (Stage2, secure loader)    |
| - full DRAM init               |
| - read FIP or individual imgs  |
| - verify signatures (FIP/IMG)  |
| - set up memory layout, MMU    |
| - load BL31, BL32 (opt), BL33  |
| - prepare entry params (x0..xN)|
+--------------------------------+
   æ³¨ï¼šåŠŸèƒ½æ›´å®Œæ•´çš„å¼•å¯¼åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å¹¶éªŒè¯åç»­å„é•œåƒã€‚
        - è´Ÿè´£ï¼šå®Œæ•´ DRAM åˆå§‹åŒ–ã€è¯»å–å­˜å‚¨ï¼ˆeMMC/SD/Flash/SPIï¼‰ã€è§£æ FIPã€‚
        - å¼ºåˆ¶éªŒè¯é“¾ï¼ˆsecure bootï¼‰ï¼šæ ¡éªŒæ¯ä¸ªé˜¶æ®µé•œåƒç­¾åï¼ˆRSA/ECDSAç­‰ï¼‰ã€‚
        - å†…å­˜/é¡µè¡¨ï¼šå¯èƒ½å»ºç«‹åˆå§‹é¡µè¡¨ã€è®¾ç½®å†…å­˜ä¿æŠ¤ã€‚
        - ä¸º BL31/BL32/BL33 å‡†å¤‡ entry å‚æ•°ï¼ˆé€šå¸¸é€šè¿‡ x0..x3 æˆ–å†…å­˜ä¸­çš„ bl_params ç»“æ„ï¼‰ã€‚
        - è°ƒè¯•ç‚¹ï¼šFIP è§£åŒ…æ—¥å¿—ã€ç­¾åéªŒè¯å¤±è´¥ä¿¡æ¯ã€åŠ è½½åœ°å€ä¸é•¿åº¦ã€‚
   |
   v
+--------------------------------+
| BL31 (EL3 runtime)             |
| - runs at EL3 (secure monitor) |
| - init EL3 vectors (VBAR_EL3)  |
| - init GIC (secure/non-sec cfg)|
| - init PSCI (power mgmt)       |
| - implement SMC handlers       |
| - handle secure world services |
+--------------------------------+
   æ³¨ï¼šTF-A çš„æ ¸å¿ƒï¼Œå¸¸é©»åœ¨ EL3ï¼ˆæœ€é«˜ç‰¹æƒï¼‰ï¼Œå®ç° Secure Monitor ä¸ runtimeã€‚
        - å¯åŠ¨å†…å®¹ï¼šè®¾ç½® EL3 å‘é‡è¡¨(VBAR_EL3)ã€åˆå§‹åŒ– GIC çš„ secure é…ç½®ã€æ³¨å†Œ SMC handlerã€‚
        - PSCIï¼šå®ç°/ä»£ç† PSCI æ¥å£ï¼Œç”¨äº CPU on/offã€ç³»ç»Ÿ suspend/resumeã€‚
        - SMCï¼šæ¥æ”¶æ¥è‡ª Non-secure çš„ SMC è°ƒç”¨å¹¶è½¬å‘æˆ–å¤„ç†ï¼ˆä¸ BL32 åä½œï¼‰ã€‚
        - ä¿æŒé©»ç•™ï¼šBL31 å¤§å¤šæ•°æ—¶é—´é©»ç•™å¹¶å“åº”è¿è¡Œæ—¶è¯·æ±‚ï¼ˆä¸å¯è¢« Non-secure è¦†å†™ï¼‰ã€‚
        - è°ƒè¯•ç‚¹ï¼šEL3 å‘é‡æ˜¯å¦æ­£ç¡®ã€SMC ID å¤„ç†è·¯å¾„ã€PSCI è¡Œä¸ºã€‚
   |                       |
   |<-- if BL32 present -->|   (BL32: TEE/secure payload)
   |                       |
   v                       v
+------+              +------------------+
| BL32 | <---SMC----> | BL31 (EL3)       |
| TEE  |              | - launches BL32  |
|      |              | - routes SMC     |
+------+              +------------------+
   æ³¨ï¼šBL32ï¼ˆå¦‚æœå­˜åœ¨ï¼‰é€šå¸¸ä¸º Trusted OSï¼ˆå¦‚ OP-TEEï¼‰ã€‚
        - BL31 å¯åŠ¨ BL32ï¼ˆsecure world çš„ EL1/EL0ï¼‰ï¼Œå¹¶ä½œä¸º SMC çš„è·¯ç”±å™¨ã€‚
        - BL32 æä¾›å—ä¿¡ä»»æœåŠ¡ï¼šå¯†é’¥ç®¡ç†ã€åŠ å¯†è¿ç®—ã€secure storageã€TAï¼ˆtrusted appsï¼‰ã€‚
        - è°ƒè¯•ç‚¹ï¼šTEE æ˜¯å¦æˆåŠŸåˆå§‹åŒ–ã€TEE æ—¥å¿—ã€SMC è½¬å‘è·¯å¾„ã€‚
   |
   v
(secure services available)
   |
   v
+--------------------------------+
| BL33 (Non-secure payload)      |
| - U-Boot / OS loader / kernel  |
| - runs in Non-secure EL1/EL2   |
| - may call BL31 via SMC/PSCI   |
+--------------------------------+
   æ³¨ï¼šéå®‰å…¨ä¸–ç•Œçš„å¼•å¯¼é•œåƒï¼Œé€šå¸¸æ˜¯ U-Boot æˆ–ç›´æ¥çš„ kernel imageï¼ˆBL33ï¼‰ã€‚
        - è¿è¡Œçº§åˆ«ï¼šNon-secure EL1ï¼ˆè‹¥æœ‰ EL2/hypervisorï¼Œåˆ™å¯èƒ½åœ¨ EL2ï¼‰ã€‚
        - BL31 åœ¨è·³è½¬å‰ä¼šè®¾ç½® ELR_EL3ã€SPSR_EL3ã€SP_EL1 ç­‰å¯„å­˜å™¨ä»¥æ§åˆ¶è¿”å›çŠ¶æ€ã€‚
        - BL33 å¯é€šè¿‡ SMC è°ƒç”¨ BL31 çš„æœåŠ¡ï¼ˆå¦‚ç”µæºç®¡ç†ã€è¯·æ±‚ TEE æœåŠ¡ç­‰ï¼‰ã€‚
        - è°ƒè¯•ç‚¹ï¼šBL31â†’BL33 çš„ SPSR/ELR è®¾ç½®æ˜¯å¦æ­£ç¡®ï¼›BL33 å¯è§çš„å¯åŠ¨å‚æ•°ï¼ˆå¦‚ DTB/ATAGSï¼‰ã€‚
   |
   v
+--------------------------------+
| OS (Linux)                     |
+--------------------------------+
   æ³¨ï¼šæœ€ç»ˆæ“ä½œç³»ç»Ÿï¼ˆLinuxï¼‰åœ¨ Non-secure åŸŸè¿è¡Œï¼Œä½¿ç”¨æ™®é€šé©±åŠ¨ä¸å†…æ ¸æœåŠ¡ã€‚
        - è‹¥å¯ç”¨äº† TEEï¼Œç”¨æˆ·æ€å¯é€šè¿‡ OP-TEE å®¢æˆ·ç«¯åº“å‘ BL32 å‘èµ·è¯·æ±‚ï¼ˆé€šè¿‡ SMCï¼‰ã€‚
        - è¿è¡Œæ—¶å®‰å…¨ï¼šEL3/BL31 ä»å¯é€šè¿‡ SMC/PSCI æä¾›ç”µæºã€å›ºä»¶å‡çº§ç­‰ runtime æœåŠ¡ã€‚

~~~

## å…­ã€å»å¯»æ‰¾fip.bin æ–‡ä»¶

~~~apl
#  ä¸ºä»€ä¹ˆè¦å»æ‰¾ fib.bin æ–‡ä»¶å‘¢ï¼Ÿå› ä¸ºæ ¹æ®ä¸Šè¿°çš„ä¿¡æ¯å’Œæµç¨‹å›¾å¯ä»¥çŸ¥é“ BL-1åˆ° BL-32çš„æµç¨‹éƒ½æ˜¯ä¼šåœ¨fip.binè¿™ä¸ªæ–‡ä»¶ä¸­ä½“ç°ï¼Œé€šè¿‡ä¸Šè¿°æµç¨‹å›¾å¯ä»¥çŸ¥é“ BL32 æä¾›å—ä¿¡ä»»æœåŠ¡ï¼šå¯†é’¥ç®¡ç†ã€åŠ å¯†è¿ç®—ã€secure storageã€TAï¼ˆtrusted appsï¼‰ã€‚æ‰€ä»¥è¿™ä¸ªæ˜¯é‡ç‚¹å…³æ³¨çš„äºŒè¿›åˆ¶æ–‡ä»¶äº†ã€‚åˆå› ä¸º BL è¿™äº›äº‹ ATF çš„å†…å®¹ æ‰€ä»¥éœ€è¦å»æ‰¾åˆ°ARM ATF å¼€æºä»£ç   https://github.com/ARM-software/arm-trusted-firmware
#  ä»€ä¹ˆæ˜¯fip.bin :fip.binï¼ˆFirmware Image Packageï¼‰æ˜¯ ARM Trusted Firmware å®šä¹‰çš„ä¸€ç§ å¤šé•œåƒæ‰“åŒ…æ ¼å¼ã€‚

git clone https://github.com/ARM-software/arm-trusted-firmware # ä¸‹è½½æºç ä¾¿äºæŸ¥æ‰¾
#  å…ˆäº†è§£ä¸€ä¸‹ fip çš„ç»“æ„
+-------------------------------+
| FIP Header (ToC Header)       |  â† é­”æ•°ã€åºåˆ—å·ã€æ ‡å¿—
+-------------------------------+
| ToC Entries (å¤šæ¡è®°å½•)        |  â† æ¯æ¡è®°å½•æè¿°ä¸€ä¸ªå›ºä»¶
+-------------------------------+
| Image Data (å®é™…å›ºä»¶æ•°æ®åŒº)   |
+-------------------------------+
#  é€šè¿‡é—®è¯¢ ai å¾—çŸ¥ FIP å®šä¹‰ç»“æ„ä½“çš„åœ°æ–¹çš„å…³é”®è¯æ˜¯toc_headerã€fip_toc_headerç­‰ç­‰
 grep ir "fip_toc_header" || true  #  æœç´¢å…³é”®è¯
#  å¦‚ä¸‹å›¾  å¾—çŸ¥ fip.binä»¥0xAA640001å¼€å¤´
~~~

![](/Image/img_v3910/3910-6.png)

![](/Image/img_v3910/3910-7.png)

![](/Image/img_v3910/3910-5.png)

~~~apl
#  åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°äº†ä½ç½® ä½¿ç”¨ dd æå– fip.bin  3FFF0 è½¬ 10 è¿›åˆ¶ä¸º 262128
dd if=stage1.bin of=fip.bin skip=262136 bs=1  #  å¾—åˆ° fip.bin æ–‡ä»¶

#  é€šè¿‡æŸ¥è¯¢æˆ‘ä»¬çŸ¥é“fip.bin æ˜¯ç”± ATF å®šä¹‰å¹¶è§£æçš„ä¸“ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼ˆFIP Formatï¼‰ï¼Œå¿…é¡»ä½¿ç”¨å¯¹åº”ç‰ˆæœ¬çš„å·¥å…·æ¥ç”Ÿæˆæˆ–è§£æã€‚åˆšåˆš clone ä¸‹æ¥çš„ä»£ç åŒ…ä¸­æ˜¯æœ‰çš„
make fiptool  #  ç¼–è¯‘å¹¶ç”Ÿæˆä¸€ä¸ªåä¸º fiptool çš„å·¥å…· tools/fiptool/
cd /tools/fiptool  #  è¿›å…¥æˆ‘ä»¬ç”Ÿæˆå·¥å…·çš„æ–‡ä»¶å¤¹ä¸‹é¢
 ./fiptool unpack ../../../fip.bin  #  unpack è§£åŒ…
 #  å¾—åˆ°äº†nt-fw.bin soc-fw.bin tb-fw.binè¿™ä¸‰ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
 #  æŠŠ nt-fw.bin ä¸¢å…¥ IDA è¿›è¡Œåˆ†æï¼Œä¸ºä»€ä¹ˆè¦åˆ†æè¿™ä¸ªæ–‡ä»¶å‘¢ å¯ä»¥çœ‹ä¸‹æ–¹æµç¨‹å›¾
 #  BL33 (Non-secure payload)----->éå®‰å…¨æœ‰æ•ˆè½½è· è¯·çœ‹ä¸‹é¢å¯åŠ¨é“¾ç»˜å›¾
strings nt-fw.bin | grep -iE 'decrypt|expand'  #  å…ˆæ£€ç´¢å…³é”®å­— expand-->è§£å‹
#  expand 32-byte k  å›æ˜¾
#  Decrypt file %s   å›æ˜¾
#  8407a Start to decrypt.  å›æ˜¾
#  983f9 aes dec key src dst len - Decrypt block of data $len bytes long å›æ˜¾
grep -r nt-fw.bin  #  å¾—çŸ¥ nt-fw.binæœ‰ç›¸å…³è§£å¯†çš„ä¿¡æ¯ ç„¶åå»æ£€ç´¢å’Œ nt-fw.binç›¸å…³çš„æ–‡ä»¶
#  arm-trusted-firmware/docs/plat/arm/juno/index.rst  å›æ˜¾  ä¸¢å…¥ IDA åˆ†æ
#  ä¸ºä»€ä¹ˆè¦å…ˆåœ¨ nt-fw.bin ä¸­æ£€ç´¢å…³é”®å­—ï¼šæ ¹æ®æµç¨‹å›¾å¯ä»¥çŸ¥é“næ‰€ä»¥è§£å¯†è¿™ç§å¯èƒ½ä¼šæš´éœ²t-fw.binæ˜¯ä¸å®‰å…¨çš„,è€Œ nt-fw.binæ˜¯BL33,BL33dçš„ä¸‹ä¸€æ­¥æ˜¯ç”ŸæˆOS,æ‰€ä»¥æˆ‘ä»¬æœ‰ç†ç”±å»æ€€ç–‘åœ¨è¿™BL33 ä¸­æœ‰åŠ è§£å¯†ç¨‹åº
#  åœºæ™¯ï¼š å®¢æˆ·å®šåˆ¶çš„å›ºä»¶è‡ªå·±ä¸ä¼šè§£ï¼Œå®‰å…¨æ€§æ²¡æ³•åšå¼ºå®¡æ ¸ï¼Œæ‰€ä»¥è§£å¯†è¿™ç§å¯èƒ½ä¼šæš´éœ²
#  ç¡®è®¤å…³é”®å­—åï¼Œå¯ä»¥æŠŠ nt-fw.bin	ä¸¢å…¥ IDA åˆ†æ(å°æ’æ›²ï¼šä¸¢å…¥IDA çš„æ—¶å€™ä¼šå‘ç°æ²¡æœ‰ä¹‹å‰çš„å‡½æ•°åˆ—è¡¨ä»€ä¹ˆ--è§£å†³åŠæ³•å°±æ˜¯ä¿®æ”¹æ¶æ„ä¸º arm é‡æ–°æ‰“å¼€)
#  æœç´¢å­—ç¬¦ä¸² Start to decrypt å®šä½åˆ°å‡½æ•° sub_5560 ç»“æœå¦‚ä¸‹å›¾
#  ç”±äºæˆ‘ä»¬è¦è§£å¯†çš„å›ºä»¶ä¸º v3910_4325.allï¼Œç”±ä¸‹å›¾çš„ä¼ªä»£ç å¯ä»¥å¾—çŸ¥ï¼ŒStart to decryptæ˜¯å¼€å§‹è§£å¯†è€Œ nonce åˆæ˜¯ç–‘ä¼¼åŠ å¯†ç®—æ³•åç§°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»v3910_4325.allä¸­å»æ‰¾ nonce å¯¹åº”çš„å€¼
#  å›ºä»¶è§£å¯†é€»è¾‘ï¼šå› ä¸ºå·²çŸ¥æˆ‘ä»¬éœ€è¦å»è§£å¯†çš„å›ºä»¶æ˜¯åŠ å¯†åçš„v3910_4325.allä¸”ä¸€èˆ¬åŠ å¯†çš„ç®—æ³•çš„æ ‡è¯†å¯†é’¥ç´¢å¼•åœ¨è¯¥æ–‡ä»¶çš„å¤´éƒ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»åˆ°åŠ å¯†åçš„v3910_4325.allçš„å¤´éƒ¨å»æ‰¾è¿™ä¸ª nonceè¿™ä¸ªæ ‡è¯†æ˜¯å¦å­˜åœ¨ å¦‚ä¸‹å›¾,è¿™æ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ° enc_image,ç”±äºéœ€è¦è·³è¿‡enc_imageæ‰€ä»¥è¦åœ¨ F0 å¼€å§‹,åˆå› ä¸º F0--->F2æ˜¯å®¹å™¨/å…ƒæ•°æ®ï¼ˆtag/é•¿åº¦/ç±»å‹ç­‰ï¼‰ï¼Œæ‰€ä»¥å®é™…çš„èµ·å§‹ç‚¹åœ¨ 0xF3ä¹Ÿå°±æ˜¯ 243ï¼Œå…·ä½“å¦‚ä¸‹å›¾
strings -t x v3910_4325.all | grep -i "thunder" # æ£€ç´¢å…³é”®å­—æ‰¾åˆ°enc_imageçš„æˆªæ–­ä½ç½®,å…·ä½“è®¡ç®—å¦‚ä¸‹å›¾
~~~

![](/Image/img_v3910/3910-8.png)

![](/Image/img_v3910/3910-9.png)

~~~apl
+-----------------------------+
| ROM Code / BL1 (SoC å†…éƒ¨)   |
| -> åˆå§‹åŒ–ç¡¬ä»¶ã€åŠ è½½ FIP     |
+-------------â†“---------------+
| tb-fw.bin (Trusted Boot, BL2) |
| -> éªŒè¯ç­¾åã€åŠ è½½ soc-fw & nt-fw |
+-------------â†“---------------+
| soc-fw.bin (SoC Firmware, BL31) |
| -> åˆå§‹åŒ– EL3 ç¯å¢ƒã€åˆ‡æ¢ä¸–ç•Œ |
+-------------â†“---------------+
| nt-fw.bin (Non-Trusted FW, BL33) |
| -> å¯åŠ¨ U-Boot/Linux ç­‰ OS |
+-----------------------------+
~~~

~~~apl
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ” ARM Trusted Firmware å¯åŠ¨é“¾                   â”‚
â”‚                        (Secure â†” Non-Secure ä¸–ç•Œåˆ‡æ¢ç¤ºæ„)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                 Power-On / Reset
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROM / BootROM (SoC å†…éƒ¨)                 â”‚
â”‚  â€¢ ä¸Šç”µæ‰§è¡Œçš„æœ€å°å¯åŠ¨ä»£ç                    â”‚
â”‚  â€¢ åŠ è½½ BL1 / éªŒè¯ç­¾åï¼ˆRoot of Trustï¼‰    â”‚
â”‚  â€¢ å·¥ä½œäº Secure ä¸–ç•Œ (EL3)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL1 (Boot Loader Stage 1)                â”‚
â”‚  â€¢ åˆå§‹åŒ– DRAMã€ä¸²å£ã€æ—¶é’Ÿ                  â”‚
â”‚  â€¢ åŠ è½½ BL2 (FIP Header 0xAA640001)       â”‚
â”‚  â€¢ éªŒè¯ç­¾åï¼Œå»ºç«‹ä¿¡ä»»é“¾                     â”‚
â”‚  â€¢ Secure ä¸–ç•Œ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL2 (Boot Loader Stage 2)                â”‚
â”‚  â€¢ ä» FIP ä¸­åŠ è½½ tb-fw.binã€soc-fw.binã€   â”‚
â”‚    nt-fw.bin                             â”‚
â”‚  â€¢ è®¾ç½®å†…å­˜æ˜ å°„ã€åˆå§‹åŒ– MMU                 â”‚ 
â”‚  â€¢ Secure ä¸–ç•Œ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL31 (EL3 Runtime / Secure Monitor)      â”‚
â”‚  â€¢ åˆå§‹åŒ–ä¸­æ–­æ§åˆ¶å™¨ GIC                     â”‚
â”‚  â€¢ åˆå§‹åŒ– PSCIï¼ˆç”µæºç®¡ç†ï¼‰                  â”‚
â”‚  â€¢ æ³¨å†Œ SMC è°ƒç”¨æœåŠ¡æ¥å£                    â”‚
â”‚  â€¢ å¯åŠ¨ BL32 (TEE, å¯é€‰)                   â”‚
â”‚  â€¢ Secure ä¸–ç•Œ (EL3)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚  (Secure Monitor Call é€šä¿¡é€šé“)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL32 (å¯é€‰, Trusted OS / TEE)            â”‚
â”‚  â€¢ ä¾‹å¦‚ OP-TEE, Trusty OS                â”‚
â”‚  â€¢ ç®¡ç†å¯†é’¥ã€åŠ å¯†æœåŠ¡ç­‰å®‰å…¨åŠŸèƒ½              â”‚
â”‚  â€¢ Secure ä¸–ç•Œ (EL1S)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚
         â–¼   ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½
         â”‚   â†“   â†“   â†“   â†“   â†“   â†“   â†“   â†“   â†“
         â”‚   â†“     ä¸–ç•Œåˆ‡æ¢ (SMC EXIT)    â†“
         â”‚   â†“     Secure â†’ Non-Secure     â†“
         â–¼   ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL33 = nt-fw.bin                         â”‚
â”‚  â€¢ Non-Trusted Firmware (éå¯ä¿¡å›ºä»¶)       â”‚
â”‚  â€¢ é€šå¸¸ä¸º U-Boot æˆ–å…¶ä»– OS åŠ è½½å™¨           â”‚
â”‚  â€¢ è¿è¡Œäº Non-Secure ä¸–ç•Œ (EL2/EL1)        â”‚
â”‚  â€¢ ä¸èƒ½è®¿é—® Secure åŒºåŸŸ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç³»ç»Ÿ (Linux / Android Kernel ç­‰)       â”‚
â”‚  â€¢ æ™®é€šåº”ç”¨ç¨‹åºã€é©±åŠ¨                       â”‚
â”‚  â€¢ Non-Secure ä¸–ç•Œ                        â”‚
â”‚  â€¢ å¯é€šè¿‡ SMC ä¸ Secure ä¸–ç•Œé€šä¿¡            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸŒ ä¸–ç•Œåˆ’åˆ†æ€»ç»“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Secure World (å¯ä¿¡)
    - ROM / BL1 / BL2 / BL31 / BL32
    - è´Ÿè´£ç­¾åéªŒè¯ã€å®‰å…¨æœåŠ¡ã€TEE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Non-Secure World (éå¯ä¿¡)
    - BL33 (nt-fw.bin)
    - æ™®é€šå¼•å¯¼åŠ è½½å™¨æˆ–æ“ä½œç³»ç»Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
~~~



![](/Image/img_v3910/3910-10.png)

![](/Image/img_v3910/3910-11.png)

![](/Image/img_v3910/3910-14.png)

![](/Image/img_v3910/3910-15.png)

![](/Image/img_v3910/3910-13.png)

## ä¸ƒã€æå–åŠ å¯†æ–‡ä»¶

~~~apl
#  ç»¼åˆä¸Šè¿°ä¿¡æ¯ æˆ‘ä»¬å¯ä»¥å¼€å§‹æå–
dd if=v3910_4325.all of=enc_Image skip=243 bs=1 count=55187968  #  æå–æ–‡ä»¶åå­—ä¸ºenc_Image
~~~

## å…«ã€æ„é€ è§£å¯†è„šæœ¬

~~~python
#  nonceæ ‡å¿—æ˜¯ chacha20 åŠ å¯†çš„æ ‡å¿—
from Crypto.Cipher import ChaCha20

def do_decrypt(enc_Image):
    nonce = b"UODAjyXZOzH0"

    with open(enc_Image, "rb") as f:
        enc_data = f.read()
    
    key = b"0DraytekKd5Eason3DraytekKd5Eason"    #ä¸ºä»€ä¹ˆæ˜¯ Eason è§£é‡Šå¦‚ä¸‹å›¾
    cipher = ChaCha20.new(key=key, nonce=nonce)
    dec_data = cipher.decrypt(enc_data)

    with open(enc_Image + "_decrypted.bin", "wb") as f:
        f.write(dec_data)
    
    print("Done!")

if __name__ == "__main__":
    filename = "enc_Image"
    do_decrypt(filename)
~~~

![](/Image/img_v3910/3910-12.png)

## ä¹ã€å¼€å§‹è§£å¯†

~~~apl
python3 decrypt_img_4325.py  #  å¼€å§‹è§£å¯† å¾—åˆ°å›æ˜¾ done è§£å¯†æˆåŠŸ
ls  #  æŸ¥çœ‹å¾—åˆ° enc_Image_decrypted.bin æ–‡ä»¶
binwalk -Me enc_Image_decrypted.bin  #  æå–å¤±è´¥
binwalk -E enc_Image_decrypted.bin  #  æŸ¥çœ‹ç†µå€¼ å¦‚ä¸‹å›¾ å‘ç°ç†µå€¼ç´Šä¹± æ‰€ä»¥æ€€ç–‘å¯èƒ½è¢«å‹ç¼©äº†,å› ä¸ºä¹‹å‰æ£€ç´¢å…³é”®å­—çš„æ—¶å€™æœ‰æ£€ç´¢åˆ°expand,ç†µå€¼æ··ä¹±ä¹Ÿè¯æ˜äº†çŒœæƒ³
binwalk enc_Image_decrypted.bin  #  æŸ¥çœ‹ä¸€ä¸‹ ä¹Ÿç¡®å®å‘ç°äº† lz4å’Œ gzipï¼Œgzip æ’é™¤çš„åŸå› æ˜¯å› ä¸ºå®ƒçš„æ ¼å¼ç±»å‹æ˜¯ASCIIè€Œ lz4 çš„æ ¼å¼ç±»å‹æ˜¯legacy,å› ä¸º binwalk ç»™åˆ°äº†è§£å‹æ–‡ä»¶çš„åœ°å€ä¸º0x9DFC18æ‰€ä»¥è¿›å…¥ IDA å®šä½è¯¥åœ°å€  å¦‚ä¸‹å›¾,é€šè¿‡å¯¹sub_991C1Cçš„åˆ†æå¾—çŸ¥,è¯¥å‡½æ•°æ˜¯ä¸€ä¸ªè§£å‹å‡½æ•°,ä¼ å…¥çš„ 2 ä¸ªå‚æ•°åˆ†åˆ«ä¸ºè§£å‹æ–‡ä»¶çš„åœ°å€å’Œæ–‡ä»¶çš„å¤§å°,åˆ°ç°åœ¨æˆ‘ä»¬å°±çŸ¥é“äº† å‹ç¼©æ–‡ä»¶çš„åç§»é‡å’Œå‹ç¼©æ–‡ä»¶çš„å¤§å°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸‹ä¸€æ­¥éœ€è¦ç”¨ dd ç»§ç»­æå– 10353688(åç§»é‡) å‹ç¼©æ–‡ä»¶çš„å¤§å°(0x2A0B6D6)è½¬ä¸ºåè¿›åˆ¶å°±æ˜¯44086998
dd if=enc_Image_decrypted.bin of=lz4_expand skip=10353688 bs=1 count=44086998
lz4 -d ./lz4_expand decompressed.bin  #  è§£å‹
binwalk -Me decompressed.bin  #  æå–æˆåŠŸ
~~~

![](/Image/img_v3910/3910-16.png)

![](/Image/img_v3910/3910-17.png)

![](/Image/img_v3910/3910-18.png)

![](/Image/img_v3910/3910-19.png)

------

# æ¼æ´å¤ç°

## ä¸€ã€æŸ¥çœ‹å¼€æœºå¯åŠ¨é¡¹åŠåˆ†æ

~~~apl
#  è§£å¯†å®Œå›ºä»¶å å¼€å§‹å¯»æ‰¾å¼€æœºå¯åŠ¨é¡¹
find . \( -name 'rc' -o -name 'rcS' \) -print #  å¯»æ‰¾å¼€æœºå¯åŠ¨é¡¹æ–‡ä»¶ å…³é”®è¯rc,rcS,rc.0 ç­‰  å¾—åˆ°å›æ˜¾./sbin/rc
cat ./sbin.rc  #  æˆ‘ä»¬æˆ‘ä»¬çŸ¥é“ è¿è¡Œäº†run.sh å¯¹ rc æŸ¥é˜…è¿˜å¾—çŸ¥ æ€»ä½“æ•ˆæœï¼šæŠŠå®¿ä¸»ä¸Šçš„ä¸€æ•´å¥—å›ºä»¶/é…ç½®æ³¨å…¥ QEMUï¼Œåˆ›å»ºç½‘ç»œã€ä¸²å£ã€å…±äº«å†…å­˜ç­‰å¤–è®¾ï¼Œè®©è¢«æ¨¡æ‹Ÿçš„ DrayOS èƒ½åƒè¿è¡Œåœ¨çœŸå®ç¡¬ä»¶ä¸Šä¸€æ ·æ¥æ”¶è¿™äº›ä¿¡æ¯ã€‚
cat ./firmware/run.sh  #  æŸ¥çœ‹è¿è¡Œçš„å¯åŠ¨è„šæœ¬ä¼šå‘ç° å¦‚ä¸‹å›¾
strings ./usr/bin/qemu-system-aarch64 | grep -i draytek  #  éªŒè¯å›æ˜¾ä¸ºDrayTekè¯å®äº†æ˜¯äºŒå¼€
find ./ -name run_linux.sh 2>/dev/null  #  å®šä½æ–‡ä»¶ä½ç½® ./firmware/run_linux.sh åœ¨ firmware æ–‡ä»¶å¤¹ä¸‹æœ‰ run_linux.shå’Œsetup_qemu_linux.sh(äºŒå¼€çš„qemué…ç½®æ–‡ä»¶)
#  å› ä¸ºæ˜¯äºŒå¼€çš„ qemu æ‰€ä»¥åœ¨å®˜æ–¹ç»™å‡ºçš„Vigor3910_GPLä¸­ä¸‹è½½å¯¹åº”çš„GPLæºç ã€‚https://gplsource.draytek.com/?dir=Vigor3910 ä¸‹è½½è¿™ä¸ªçš„åŸå§‹æ˜¯å› ä¸ºè¿™ä¸ª qemu æ˜¯äºŒå¼€çš„æ‰€ä»¥éœ€è¦æˆ‘ä»¬é‡æ–°ç¼–è¯‘
tar -xvjf new_v3910_v396_GPL_release.tar.bz2  #  è§£å‹
cd Vigor3910_v396_GPL_release/  #  è¿›å…¥è¯¥æ–‡ä»¶å¤¹ä¸‹
cat ReadMe.txt  #  æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•
sudo apt-get install liblz4-tool  #  å®‰è£…éœ€è¦çš„å·¥å…·
 ./bulid  #  æ–‡æ¡£ä¸­è¯´æ˜ Before you execute ./build å®‰è£…å®Œåæ‰§è¡Œï¼Œè¿™æ—¶å€™æˆ‘ä»¬å‘ç°æ— æ³•æ­£å¸¸ä½¿ç”¨./bulidã€‚ä¼šæŠ¥é”™è¯´ "Only support X86 64 bit." è¿™æ—¶å€™æœ‰ä¸ªå¤§èƒ†çš„æƒ³æ³• 
 nano bulid #  æ‰¾åˆ°æŠ¥é”™çš„åœ°æ–¹ç”¨#æ³¨é‡Šç»•è¿‡åé‡æ–°æ‰§è¡Œ å‘ç°å¯ä»¥æˆåŠŸæ‰§è¡Œäº† 
 ls  #  è¿è¡Œå®ŒåæŸ¥çœ‹ç›®å½•ä¸‹ å¹¶æ²¡æœ‰æˆ‘ä»¬qemuç¼–è¯‘åçš„æ–‡ä»¶ ä½†æ˜¯å‘ç°äº† sourceæºæ–‡ä»¶å¤¹ï¼Œè¿›å»åä¼šå‘ç°qemu-2.12.1.tar.bz2çš„å‹ç¼©æ–‡ä»¶
 tar -xvjf qemu-2.12.1.tar.bz2  #  è§£å‹è¯¥æ–‡ä»¶ å¾—åˆ° linux æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬ä¸€è·¯å‘ä¸‹/Vigor3910_v396_GPL_release/source/linux/cavium-rootfs/src_dir/qemu-2.12.1åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ç¼–è¯‘æˆ‘ä»¬çš„ qemu-system
 ./configure --enable-kvm --enable-debug --target-list=aarch64-softmmu  #  é…ç½®å¼€å¯è™šæ‹ŸåŒ–å’Œè°ƒè¯•æ¨¡å¼å¹¶æŒ‡å®šç¼–è¯‘åçš„ç›®æ ‡åˆ—è¡¨åœ¨ arrch64-softmmu ä¸‹
 make  #  æŠ¥é”™ERROR: glib-2.22 gthread-2.0 is required to compile 
 sudo apt install libglib2.0-dev  #  å®‰è£…ç¼ºå°‘çš„åº“
 make  #  æŠ¥é”™ERROR: pixman >= 0.21.8 not present.Please install the pixman devel package.
 sudo apt install libpixman-1-dev  #  å®‰è£…ä¿®è¦çš„ä¾èµ–
 make  #  ç¼–è¯‘---!!âš ï¸æœ€å‚»é€¼çš„åœ°æ–¹æ¥äº†âš ï¸make çš„æ—¶å€™ä½ ä¼šå‘ç°æŠ¥é”™äº† å¦‚ä¸‹å›¾
 find ./ -name arm-a64.cc 2>/dev/null  #  å®šä½æŠ¥é”™æ–‡ä»¶./disas/arm-a64.cc
 naon ./disas/arm-a64.cc  #  ä¿®æ”¹é”™è¯¯æ–‡ä»¶ å…·ä½“å¦‚ä¸‹å›¾ é”™è¯¯çš„åŸå› æ˜¯ extern æ²¡æœ‰è¢«æ­£ç¡®å¼•ç”¨
 make clean  #  æ¸…æ¥š make é…ç½®
 make  #  é‡æ–°ç¼–è¯‘
 cd arrch64-softmmu  # è¿›å…¥ç›®æ ‡åˆ—è¡¨ æ‰¾åˆ°ç¼–è¯‘å¥½çš„ qemu-system-aarch64 æ–‡ä»¶ï¼ŒæŠŠè¯¥æ–‡ä»¶ cp åˆ°/_decompressed.bin.extracted/cpio-root/firmwareè¿™ä¸ªç›®å½•ä¸‹ ä¿®æ”¹å¯åŠ¨è„šæœ¬ï¼Œæ³¨é‡Šæ‰setup_qemu_linux.shä¸­çš„è®¾ç½®é‡ç½®ç½‘ç»œéƒ¨åˆ†ã€‚ï¼ˆé˜²æ­¢å‡ºç°æ„å¤–ï¼‰
~~~

![](/Image/img_v3910/3910fx-1.png)

![](/Image/img_v3910/3190fx-2.png)

~~~sh
# ä¿®æ”¹åçš„ run_linux.sh å¯åŠ¨è„šæœ¬ ä¸»è¦æ˜¯æŠŠå®ä½“å›ºä»¶è¿è¡Œå…¨éƒ¨æ”¹ä¸ºè™šæ‹ŸåŒ–è¿è¡Œè„šæœ¬
#!/bin/bash
# 1. do "fw_setenv purelinux 1" first , then reboot
# 2. do setup_qemu_linux.sh (default P3 as WAN, P4 as LAN, for both 1Gbps connection only)
# 3. remember to recover to normal mode by "fw_setenv purelinux 0"

rangen() {
   printf "%02x"  `shuf -i 1-255 -n 1 `
}


rangen1() {
   printf "%x"  `shuf -i 1-15 -n 1 `
}

wan_mac(){
        idx=$1
        printf "%02x\n" $((0x${C}+0x$idx)) | tail -c 3 # 3 = 2 digit + 1 terminating character
}

A=$(rangen); B=$(rangen); C=$(rangen);
LAN_MAC="00:1d:aa:${A}:${B}:${C}"

if [ ! -p serial0 ]; then
    mkfifo serial0
fi
if [ ! -p serial1 ]; then
    mkfifo serial1
fi

platform_path="./platform"
echo "x86" > $platform_path
enable_kvm_path="./enable_kvm"
echo "kvm" > $enable_kvm_path

cfg_path="./magic_file"

echo "GCI_SKIP" > gci_magic

mkdir -p ../data/uffs
touch ../data/uffs/v3910_ram_flash.bin
uffs_flash="../data/uffs/v3910_ram_flash.bin"

echo "1" > memsize

(sleep 20 && ethtool -K qemu-lan tx off) &

model="./model"
echo "3" > ./model

rm -rf ./app && mkdir -p ./app/gci
GCI_PATH="./app/gci"
GCI_FAIL="./app/gci_exp_fail"
GDEF_FILE="$GCI_PATH/draycfg.def"
GEXP_FLAG="$GCI_PATH/EXP_FLAG"
GEXP_FILE="$GCI_PATH/draycfg.exp"
GDEF_FILE_ADDR="0x4de0000"
GEXP_FLAG_ADDR="0x55e0000"
GEXP_FILE_ADDR="0x55e0010"

echo "0#" > $GEXP_FLAG
echo "19831026" > $GEXP_FILE
echo "GCI_SKIP" > $GDEF_FILE

SHM_SIZE=16777216
./qemu-system-aarch64 -M virt,gic_version=3 -cpu cortex-a57 -m 1024 -L ../usr/share/qemu \
           -kernel ./vqemu/sohod64.bin $serial_option -dtb DrayTek \
           -nographic $gdb_serial_option $gdb_remote_option \
           -device virtio-net-pci,netdev=network-lan,mac=${LAN_MAC} \
           -netdev tap,id=network-lan,ifname=qemu-lan,script=no,downscript=no \
           -device virtio-net-pci,netdev=network-wan,mac=00:1d:aa:${A}:${B}:$(wan_mac 1) \
           -netdev tap,id=network-wan,ifname=qemu-wan,script=no,downscript=no \
           -device virtio-serial-pci -chardev pipe,id=ch0,path=serial0 \
           -device virtserialport,chardev=ch0,name=serial0 \
           -device loader,file=$platform_path,addr=0x25fff0 \
           -device loader,file=$cfg_path,addr=0x260000 \
           -device loader,file=$uffs_flash,addr=0x00be0000 \
           -device loader,file=$enable_kvm_path,addr=0x25ffe0 \
           -device loader,file=memsize,addr=0x25ff67 \
	        -device loader,file=$model,addr=0x25ff69 \
           -device loader,file=$GDEF_FILE,addr=$GDEF_FILE_ADDR \
           -device loader,file=$GEXP_FLAG,addr=$GEXP_FLAG_ADDR \
           -device loader,file=$GEXP_FILE,addr=$GEXP_FILE_ADDR \
           -device nec-usb-xhci,id=usb \
           -device ivshmem-plain,memdev=hostmem \
           -object memory-backend-file,size=${SHM_SIZE},share,mem-path=/dev/shm/ivshmem,id=hostmem
~~~

## äºŒã€å›ºä»¶æ¨¡æ‹Ÿ

~~~apl
sudo ./setup_qemu_linux.sh  #  è¿è¡Œç½‘ç»œé…ç½®æ–‡ä»¶
sudo ./run_linux.sh  #  ä½¿ç”¨è„šæœ¬æ¨¡æ‹Ÿå¯åŠ¨ç¯å¢ƒ
~~~



![](/Image/img_v3910/3910fx-4.png)

![](/Image/img_v3910/3910fx-5.png)

## ä¸‰ã€é™æ€åˆ†æ

~~~Â apl
#  çœ‹åˆ°ç™»å½•é¡µé¢ æˆ‘ä»¬å…ˆæ‰“å¼€ burp å¼€å¯æŠ“åŒ… å°è¯•ç”¨ admin adminï¼Œå¼±å£ä»¤ç™»å½•å¹¶è§‚å¯Ÿ burpæŠ“åŒ…çš„è¯·æ±‚ï¼Œå‘ç°å¤„ç†å‰åç«¯äº¤äº’post è¯·æ±‚çš„ä¾æ—§æ˜¯cgiè¿›è¡Œå¤„ç†çš„ï¼Œåˆå› ä¸ºæˆ‘ä»¬ä¹‹å‰çš„å¯åŠ¨è„šæœ¬ run_linux.shä¸­-kernel ./vqemu/sohod64.bin $serial_option -dtb DrayTek \  sohod64.binæ˜¯DrayTekçš„ osï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰æŠŠsohod64.binä¸¢å…¥IDAåˆ†æ
#  å·²çŸ¥æˆ‘ä»¬å¤„ç†å‰åç«¯äº¤äº’post è¯·æ±‚çš„ä¾æ—§æ˜¯cgiè¿›è¡Œå¤„ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å»å®šä½ wlogin.cgi å‘ç°äº† wloginauth.cgi(ç™»å½•è®¤è¯)å®šä½å‡½æ•°sub_40156840 å¦‚ä¸‹å›¾,é€šè¿‡äº¤å‰å¼•ç”¨å‘ç°äº†sub_40156840çš„ä¸Šä¸€å±‚æ˜¯sub_4015F640ï¼Œäºæ˜¯æˆ‘ä»¬è¿›å…¥åˆ°è¯¥å‡½æ•°å»è¿›è¡Œåˆ†æ
~~~

![](/Image/img_v3910/3910fx-6.png)

![](/Image/img_v3910/3910fx-7.png)

## å››ã€å‡½æ•°sub_4015F640å¤§ä½“åˆ†æ

å‡½æ•°åï¼š

```apl
__int64 __fastcall sub_4015F640(unsigned int a1)
å‚æ•°a1: é€šå¸¸ä¸ºè¯·æ±‚ä¸Šä¸‹æ–‡ç»“æ„ä½“æŒ‡é’ˆï¼ˆæ¯”å¦‚ HTTP è¯·æ±‚ä¿¡æ¯ã€ä¼šè¯çŠ¶æ€ã€socketè¿æ¥ç­‰ï¼‰ã€‚
è¿”å›å€¼__int64ï¼šè¿”å›å†…éƒ¨å‡½æ•°è°ƒç”¨çš„ç»“æœç ï¼ˆresultï¼‰ï¼Œå¯èƒ½ä»£è¡¨ HTTP çŠ¶æ€ç æˆ–å†…éƒ¨å¤„ç†ç ã€‚
```

æ€»ä½“é€»è¾‘ç»“æ„ï¼š

~~~apl
è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªæ ¸å¿ƒåˆ†å‘æ§åˆ¶å‡½æ•°ï¼ˆdispatcherï¼‰
 å®ƒæ ¹æ® sub_40156840((_BYTE *)(a1 + 15916), *(_DWORD *)(a1 + 15608)) çš„è¿”å›å€¼ï¼ˆå³ resultï¼‰è¿›è¡Œå¤šå±‚æ¬¡æ¡ä»¶åˆ¤æ–­ã€‚
 è¿™äº› result å€¼å¯¹åº”ä¸åŒçš„è¯·æ±‚ç±»å‹æˆ–å‘½ä»¤ç ï¼Œä¾‹å¦‚ï¼š
-  10031 ,  10085 ,  10101 ,  13321 ,  13322  ...
-  7001 ,  6502 ,  707 ,  701 ,  702  ...
- å¾ˆå¤šéƒ½æ˜¯åå…­è¿›åˆ¶å½¢å¼çš„ CGI ç¼–å·ï¼ˆ 0x2731 ï½ 0x277E ï¼‰ï¼Œæå¯èƒ½æ˜¯è®¾å¤‡çš„ CGI è·¯å¾„å¯¹åº”ç¼–å·ã€‚
~~~

æ ¸å¿ƒè°ƒç”¨å…³ç³»ï¼ˆé‡è¦å‡½æ•°ï¼‰

| å‡½æ•°å                    | æ¨æµ‹åŠŸèƒ½               | åˆ†æ                                                         |
| ------------------------- | ---------------------- | ------------------------------------------------------------ |
| sub_40156840              | è¯·æ±‚è§£æå‡½æ•°           | è§£æ CGI è¯·æ±‚åæˆ–æ“ä½œç ï¼ˆæ¯”å¦‚  /auth_check.cgi ï¼‰ã€‚          |
| sub_4010E084              | æƒé™éªŒè¯               | å‚æ•°ä¸ºå­—ç¬¦ä¸²  "/auth_check.cgi" ï¼Œå¯èƒ½ç”¨äºæ£€æŸ¥ç™»å½•æ€æˆ–è®¤è¯ cookieã€‚ |
| sub_40D16D34              | Session æˆ–æƒé™æ£€æŸ¥å‡½æ•° | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆè¿”å›çœŸè¡¨ç¤ºå·²ç™»å½•ï¼‰ã€‚                     |
| sub_400CF818(code, param) | å“åº”å‘é€å‡½æ•°           | ç”¨äºè¿”å› HTTP çŠ¶æ€æˆ– CGI é”™è¯¯ç ã€‚                            |
| sub_401590C0              | æ–‡ä»¶/é…ç½®éªŒè¯å‡½æ•°      | æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–æœ‰æ•ˆã€‚                                 |

| æ¨¡å—                | åŠŸèƒ½         | é£é™©ç‚¹                     |
| ------------------- | ------------ | -------------------------- |
| sub_40156840        | CGIå‘½ä»¤è§£æ  | å‚æ•°æº¢å‡º / è¶Šç•Œ            |
| sub_4010E084        | è®¤è¯æ£€æŸ¥     | å¯å°è¯•ç»•è¿‡                 |
| sub_40D16D34        | SessionéªŒè¯  | è‹¥è¿”å›å€¼å¯æ§ï¼Œå¯ä¼ªé€ ç™»å½•æ€ |
| sub_400CF818        | å“åº”å‡½æ•°     | æ§åˆ¶è¾“å‡ºå†…å®¹               |
| "exec_cgi_script_*" | å®é™…æ‰§è¡Œå‘½ä»¤ | RCEæ½œåœ¨å…¥å£                |

![](/Image/img_v3910/3910fx-8.png)

~~~apl
#  åœ¨æˆ‘ä»¬åˆ†ææ•´æ®µsub_4015F640çš„æ—¶å€™æˆ‘ä»¬çœ‹åˆ°äº†	cfg_gci_export_script è§£é‡Šå¦‚ä¸‹å›¾
#  ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æŒ‰ç…§çŒœæƒ³å»åœ¨è¿™é‡Œæ‰§è¡Œçš„æ—¶å€™æˆ‘ä»¬çš„å‰ç½®æ¡ä»¶å°±æ˜¯åœ¨sub_401590C0å‡½æ•°å¤„ç†ä¸­ï¼Œè¿”å›å€¼ä¸º0æ‰å¯ä»¥å»èµ°sub_400FC818(6992,"cfg_gci_export_script")çš„æ“ä½œ
#  çŸ¥é“æˆ‘ä»¬æƒ³è¦çš„sub_400FC818(6992,"cfg_gci_export_script")ä»¥åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹sub_4010E084 å’Œ sub_40D15D34 å’Œ sub_401590C0 è¿›è¡Œåˆ†æ
~~~

![](/Image/img_v3910/3910fx-16.png)

~~~apl
#  sub_4010E084 åˆ†æ
#  ç”±ä¸Šå›¾å¯çŸ¥æƒ³èµ°åˆ°return sub_400CF818(6992, "cfg_gci_export_script");çš„æ—¶å€™
#  å¿…é¡»è¦ if ( (_DWORD)result != -1 ) æˆç«‹
#  ç”±ä¸‹å›¾æ¨æ–­å¯çŸ¥ åªè¦è¿›å…¥sub_4010E084 å°±ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œ
~~~

![](/Image/img_v3910/3910fx-19.png)

~~~apl
#  sub_4010CE00 åˆ†æ
#  å†è¿›å…¥åˆ° sub_4010CE00 çš„æ—¶å€™ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯åœ¨åšä¸€ä¸ªurl æ˜¯å¦æ‹¼æ¥/image/çš„æ£€æŸ¥
#  å‘ä¸‹æ‰§è¡Œçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥çœ‹åˆ°
#  v35è¢«èµ‹å€¼äº†åœ¨httpä¸­æå–åˆ°çš„cookie
#  v34è¢«èµ‹å€¼äº†åœ¨cookieä¸­æå–å‡ºæ¥çš„session_id
#  v33è¢«èµ‹å€¼äº†è®¡ç®—å‡ºæ¥åçš„session_id é•¿åº¦
#  ç¬¬ä¸€ä¸ªåˆ¤æ–­æ²¡æœ‰åˆæ³•çš„ç™»å½• Cookie å¹¶ä¸”å½“å‰è®¿é—®çš„é¡µé¢ä¸æ˜¯/weblogin.htmã€cgierr.htmã€/images/ ç­‰å…¬å¼€é¡µé¢å¹¶ä¸” sub_4010CD68(path) åˆ¤æ–­è¯¥é¡µé¢éœ€è¦ç™»å½•æƒé™åˆ™å»LABEL_116(302ï¼Œé‡å®šå‘ç½®ç™»å½•é¡µé¢)
#  ç¬¬äºŒä¸ªåˆ¤æ–­å¦‚æœå½“å‰è®¿é—®çš„è·¯å¾„å±äºï¼šç™»å½•é¡µ (/weblogin.htm)CGIé”™è¯¯é¡µ(/doc/cgierr.htm)ã€å›¾ç‰‡ç›®å½• (/images/)æˆ–è€… sub_4010CD68(path) è¿”å› falseï¼ˆå³ä¸å—ä¿æŠ¤é¡µé¢åˆ™è·³è¿‡ç™»å½•æ£€æŸ¥é€»è¾‘ï¼Œç›´æ¥æ‰§è¡Œ LABEL_121ï¼ˆæ­£å¸¸ç»“æŸï¼‰
~~~

![](/Image/img_v3910/3910fx-23.png)

![](/Image/img_v3910/3910fx-24.png)

~~~apl
#  sub_40D15D34 åˆ†æ
#  1ã€è¿›å…¥è¯¥å‡½æ•°åçš„åˆå§‹åŒ–æ“ä½œ
#  2ã€è¡¨å•èµ‹å€¼ç»™v5åè¿›è¡Œåˆ¤æ–­
#  3ã€å¦‚æœä¸ºçœŸï¼ˆè¡¨å•å­˜åœ¨ï¼‰ï¼Œè¿”å›å€¼ä¸ºï¼=0å³1
#     å¦åˆ™ï¼ˆè¡¨å•ä¸å­˜åœ¨ï¼‰
#     è¿”å›0
#  ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨ç™»å½•çš„æ—¶å€™ä¼šæ„é€ ä¸€ä¸ªè¡¨å•ï¼Œè¿™ä¸ªè¡¨å•æ˜¯ä¸€å®šå­˜åœ¨çš„ï¼Œæ‰€ä»¥ä»–çš„å‡½æ•°è¿”å›å€¼ä¸º !=0
#  å¸¦ç€è¿™ä¸ª!=0å†è¿”å›åˆ°sub_40D15D34çš„ä¸Šä¸€å±‚å°±å¯ä»¥çŸ¥é“ ç¨‹åºä¼šç»§ç»­æ‰§è¡Œæƒ³ä¸‹èµ°
~~~

![](/Image/img_v3910/3910fx-17.png)

![](/Image/img_v3910/3910fx-20.png)

~~~apl
#  sub_401590C0  åˆ†æ
#  å³ä¸‹å›¾å¯çŸ¥ï¼Œåªè¦è¿›å…¥åå¿…ç„¶ä¼šè¿”å›0æ‰§è¡Œä¸‹ä¸€æ­¥ä¹Ÿå°±æ˜¯ 
#  return sub_400CF818(6992, "cfg_gci_export_script");
~~~

![](/Image/img_v3910/3910fx-22.png)



~~~apl
#  å¦‚æœè¦è®©ä¸Šè¿°æµç¨‹å…¨éƒ¨æ‰§è¡Œä¸‹æ¥çš„çš„å‰ç½®æ¡ä»¶å°±æ˜¯éœ€è¦å»åˆ†æif ( (_DWORD)result == 7015 )
#  ä¸Šé¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡if ( (_DWORD)result == 7015 )è¿™ä¸ªæ­¥éª¤æ˜¯è¿”å›è·¯å¾„åˆ†å‘åçš„æ‰§è¡Œç 
#  åˆå› ä¸ºæˆ‘ä»¬è¿›å…¥ sub_4015F640 åçš„ç¬¬ä¸€æ­¥å°±æ˜¯å»æ‰§è¡Œè·¯å¾„åˆ†å‘(sub_40156840)
#  æ¥ä¸‹æ¥éœ€è¦å»sub_40156840ä¸­æ‰¾åˆ°æ˜¯æ‰§è¡Œäº†ä»€ä¹ˆè·¯å¾„åˆ†å‘ä¼šèµ° sub_40156840
#  com+F å®šä½ 7015
#  å¾—åˆ°åˆ†å‘è·¯å¾„ /Draytek.exp
~~~

![](/Image/img_v3910/3910fx-21.png)

æ€»ç»“

~~~apl
#  é€šè¿‡ä¸Šè¿°çš„åˆ†ææ¨ç†æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çŸ¥é“
#  æƒ³è¦å»æ‰§è¡Œ "cfg_gci_export_script",çš„å‰ç½®æ¡ä»¶ä¸ºéœ€è¦
#  POSTè¯·æ±‚/Dratek.exp/image/?sFormAuthStr
#  å‘ç°è¯·æ±‚æˆåŠŸï¼Œä½†æ˜¯å†…å®¹æ˜¯ä¹±ç ï¼Œä¹Ÿå°±æ˜¯è¯´è¿”å›å€¼è¢«åŠ å¯†äº†
~~~

éªŒè¯

~~~apl
#  æ„é€ è¯·æ±‚å¤´ä¿¡æ¯
POST /Draytek.exp/images/?sFormAuthStr= HTTP/1.1
Host: 192.168.1.1
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 65
~~~

![](/Image/img_v3910/3910fx-25.png)

è§£å¯†é˜¶æ®µ

~~~apl
#  å»IDA æœç´¢å…³é”®å­— encrypt å®šä½åˆ°äº†å‡½æ•° sub_400CF818 è¿›å…¥æŸ¥çœ‹
#  å‘ç°äº†åŠ å¯†é…ç½®å’ŒåŠ å¯†å¯†ç éƒ½æ˜¯ ä¼ å…¥äº†sub_40D1825C è¿›è¡Œå¤„ç†
#  è¿›å…¥ä¼ª C ä»£ç è¿›è¡Œåˆ†æå¯ä»¥çŸ¥é“
#  chk_encryptcfg å’Œ sEncryptPwd éƒ½æ˜¯ä¸¢å…¥äº†sub_40D1825Cè¿›è¡Œå¤„ç†çš„,è¿™è¿ä¸ªå¤„ç†å®Œåéƒ½æ˜¯ä¸¢å…¥v721 æ•°ç»„ä¸­è¿›è¡Œå­˜å‚¨ï¼Œv721åˆè¢«sub_40A37D64 å¤„ç†,æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›å…¥è¿™ä¸ªå‡½æ•°çœ‹ä¸‹æ˜¯æ€ä¹ˆå¤„ç†çš„è¿™ä¸ªåŠ å¯†é…ç½®æ–‡ä»¶å’ŒåŠ å¯†å¯†ç çš„
#  è¿›å…¥ sub_40A37D64 åå¯ä»¥çœ‹åˆ° if ( v47 != 170 && v47 != 187 && v47 != 204 )
#  è¿™é‡Œæˆ‘ä»¬çŒœæµ‹ å¦‚æœchk_encryptcfg!=170å’Œ 187 å’Œ 204 å°±æ˜¯åŠ å¯†çš„
#  å†å¾€ä¸‹çœ‹ä¼šå‘ç°å¦‚æœ=204å°±ä¼šå‡ºç°ä¸€å †ä¹±ç 
#  æ‰€ä»¥åœ¨æ„é€ è¯·æ±‚å¤´çš„æ—¶å€™éœ€è¦åŠ å…¥ chk_encryptcfg=180 æˆ– 187
~~~

![](/Image/img_v3910/3910fx-26.png)

![](/Image/img_v3910/3910fx-27.png)

![](/Image/img_v3910/3910fx-28.png)

![](/Image/img_v3910/3910fx-29.png)



ä¸ºä»€ä¹ˆæ–­å®šsFormAuthStræ˜¯è¡¨å•å’ŒéªŒè¯æ˜¯è¡¨å•æ—¶å€™çš„æ„å¤–å‘ç°

~~~apl
#  æµç¨‹å…¥ä¸‹
#  æ„å¤–å‘ç°ï¼šåœ¨éªŒè¯è¿‡ç¨‹ä¸­å‘ç°äº†è´¦å·å¯†ç ä½¿ç”¨äº† base64 è¿›è¡Œäº†åŠ å¯†
~~~

![](/Image/img_v3910/3910fx-15.png)

![](/Image/img_v3910/3910fx-11.png)

![](/Image/img_v3910/3910fx-12.png)

![](/Image/img_v3910/3910fx-13.png)

![](/Image/img_v3910/3910fx-14.png)

------



# Draytek_v3910 Decryption

### 1. Known to be aarch64

#### âœ… Brief Explanation:

- **Vendor**: Cavium (later acquired by Marvell)
- **Architecture**: ARMv8-A (compatible with the aarch64 instruction set)
- **Use cases**: High-performance embedded systems, network security devices, enterprise routers, data center servers.
- **Common product lines**:
  - ThunderX (1st generation)
  - ThunderX2 (improved performance, more cores supported)
  - ThunderX3 (up to 96 cores)

### 2. Based on known info we can drop `v3910_3971.all` into IDA to inspect HEX

![img](/Image/img_v3910/3901-1.png)

![img](/Image/img_v3910/3910-3.png)

![img](/Image/img_v3910/3910-4.png)

### 3. Reverse verification â€” use grep

```apl
# b: print offset  o: print match  a: treat the binary as text
grep -boa $'\x54\x48\x55\x4E\x44\x45\x52\x58' v3910_3971.all 
#  131168:THUNDERX    output: convert decimal to hex to get boot.bin
#  327776:THUNDERX    output: convert decimal to hex -> unused
#  1600608:THUNDERX   output: convert decimal to hex -> init.bin
#  4194400:THUNDERX   output: convert decimal to hex -> ATF stage1
#  5160445:THUNDERX   output: convert decimal to hex -> unused
```

### 4. Extract using dd

```apl
dd if=v3910_3971.all bs=1 skip=4194400 of=stage_1.bin  # Obtained the binary file
# Drop it into IDA to analyze HEX
```

### 5. Understand basic info

```apl
# Typical contents of ATF images and FIP (Firmware Image Package)

BL1: ROM / early init, extremely small; usually not a binary in TF-A source tree (provided by platform).

BL2 (TF-A optional or platform BL2): responsible for loading BL31/BL32/BL33.

BL31: EL3 runtime (TF-A core) â€” the tf-a bl31.elf.

BL32: TEE (OP-TEE) tee.bin.

BL33: Non-secure bootloader (U-Boot) or kernel.

FIP: fip.bin contains multiple segments (BL2/BL31/BL32/BL33), usually with a header and signatures.
```

#### Flowchart

```apl
POWER/RESET
   |
   v
+--------------------------------+
| ROM / BootROM (on-chip ROM)    |
| - minimal loader               |
| - may verify BL1/BL2 signature |
+--------------------------------+
   Note: After chip power-on, the first code executed is the on-chip ROM/BootROM.
         - Very small code: early hardware init (clocks, reset), select boot medium.
         - May implement Root-of-Trust: verify signature of the next stage (BL1/BL2/FIP).
         - Debug points: early serial output, BootROM errors, ROM logs (if any).
   |
   v
+--------------------------------+
| BL1 (Stage1)                   |
| - early debug UART             |
| - minimal clocks, DRAM init    |
| - load BL2 or FIP to DRAM      |
| - verify signatures (secure)   |
+--------------------------------+
   Note: First-stage bootloader (usually small & trusted), loads BL2 or FIP to DRAM.
         - Functions: initialize UART for serial prints, minimal clock and DDR controller init.
         - May perform signature verification (secure boot chain).
         - Handoff: pass BL2/FIP memory addr/size to BL2 and jump.
         - Debug points: serial early boot messages, DRAM init failure messages.
   |
   v
+--------------------------------+
| BL2 (Stage2, secure loader)    |
| - full DRAM init               |
| - read FIP or individual imgs  |
| - verify signatures (FIP/IMG)  |
| - set up memory layout, MMU    |
| - load BL31, BL32 (opt), BL33  |
| - prepare entry params (x0..xN)|
+--------------------------------+
   Note: More complete bootloader, responsible for loading and verifying subsequent images.
         - Responsibilities: full DRAM init, read storage (eMMC/SD/Flash/SPI), parse FIP.
         - Enforce verification chain (secure boot): verify each image signature.
         - Memory / page tables: may set up initial page tables, memory protections.
         - Prepare entry params (x0..x3 or bl_params structures).
         - Debug points: FIP unpack logs, signature verification failures, load addresses and sizes.
   |
   v
+--------------------------------+
| BL31 (EL3 runtime)             |
| - runs at EL3 (secure monitor) |
| - init EL3 vectors (VBAR_EL3)  |
| - init GIC (secure/non-sec cfg)|
| - init PSCI (power mgmt)       |
| - implement SMC handlers       |
| - handle secure world services |
+--------------------------------+
   Note: TF-A core, resident at EL3 (highest privilege), implements Secure Monitor.
         - Startup: set EL3 vector table (VBAR_EL3), init secure parts of GIC, register SMC handlers.
         - PSCI: implement/proxy PSCI interface for CPU on/off and power management.
         - SMC: handle Secure Monitor Calls from Non-secure, coordinate with BL32.
         - Mostly resident: BL31 remains to respond to runtime requests.
         - Debug points: EL3 vector correctness, SMC ID handling, PSCI behavior.
   |                       |
   |<-- if BL32 present -->|   (BL32: TEE / secure payload)
   |                       |
   v                       v
+------+              +------------------+
| BL32 | <---SMC----> | BL31 (EL3)       |
| TEE  |              | - launches BL32  |
|      |              | - routes SMC     |
+------+              +------------------+
   Note: BL32 (if present) is the Trusted OS (e.g., OP-TEE).
         - BL31 launches BL32 and routes SMCs.
         - BL32 provides trusted services: key management, crypto, secure storage, TAs.
         - Debug points: TEE initialization, TEE logs, SMC routing paths.
   |
   v
(secure services available)
   |
   v
+--------------------------------+
| BL33 (Non-secure payload)      |
| - U-Boot / OS loader / kernel  |
| - runs in Non-secure EL1/EL2   |
| - may call BL31 via SMC/PSCI   |
+--------------------------------+
   Note: Non-secure payload, typically U-Boot or kernel image (BL33).
         - Execution level: Non-secure EL1 (or EL2 if hypervisor present).
         - BL31 sets registers (ELR_EL3, SPSR_EL3, SP_EL1) before returning.
         - BL33 can call BL31's services via SMC (e.g., power management, TEE requests).
         - Debug points: BL31â†’BL33 SPSR/ELR settings, boot params (DTB/ATAGS).
   |
   v
+--------------------------------+
| OS (Linux)                     |
+--------------------------------+
   Note: Final OS runs in Non-secure world.
         - If TEE enabled, user-space can contact BL32 via client libraries (via SMC).
         - Runtime security: BL31/EL3 can still provide power/firmware services at runtime.
```

## 6. Locate `fip.bin` file

```apl
# Why find fip.bin? Because BL1-BL32 stages are represented in fip.bin. BL32 provides trusted services:
# key management, crypto, secure storage, trusted apps. So fip.bin is a critical binary.
# Because ATF defines these BL images, we should inspect the ARM Trusted Firmware source:
# https://github.com/ARM-software/arm-trusted-firmware

git clone https://github.com/ARM-software/arm-trusted-firmware # download source for reference
# First learn fip structure
+-------------------------------+
| FIP Header (ToC Header)       |  â† magic, version, flags
+-------------------------------+
| ToC Entries (multiple records)|
+-------------------------------+
| Image Data (actual image data)|
+-------------------------------+
# By asking AI we find keys like toc_header / fip_toc_header in source
grep ir "fip_toc_header" || true  # search keywords
# We see fip.bin starts with 0xAA640001 as magic
```



![img](/Image/img_v3910/3910-6.png)

![img](/Image/img_v3910/3910-7.png)

![img](/Image/img_v3910/3910-5.png)

```apl
# Found location in the file. Use dd to extract fip.bin. 3FFF0 (hex) -> decimal 262128
dd if=stage1.bin of=fip.bin skip=262136 bs=1  # obtain fip.bin

# fip.bin is a multi-image format defined by ATF; corresponding tools in the source can parse it.
make fiptool  # build a tool named fiptool under tools/fiptool/
cd tools/fiptool
./fiptool unpack ../../../fip.bin  # unpack
# Obtained nt-fw.bin soc-fw.bin tb-fw.bin
# Put nt-fw.bin into IDA for analysis: why analyze nt-fw.bin? See boot chain diagram above.
strings nt-fw.bin | grep -iE 'decrypt|expand'  # search for keywords expand -> compression
# expand 32-byte k  output
# Decrypt file %s   output
# 8407a Start to decrypt.  output
# 983f9 aes dec key src dst len - Decrypt block of data $len bytes long  output
grep -r nt-fw.bin  # find references; then inspect related files
# Example: arm-trusted-firmware/docs/plat/arm/juno/index.rst  -> put into IDA for analysis
# We search nt-fw.bin for decrypt keywords since nt-fw.bin (BL33) may expose decryption routines.
# BL33 often contains code that prepares or consumes payloads for OS; if decrypt exists here, it can expose logic.
# When dropping nt-fw.bin into IDA, you may need to set architecture to arm (not auto aarch64) to get functions visible.
# Find the string "Start to decrypt" at function sub_5560; we will search for corresponding nonce in v3910_4325.all
# Encrypted firmware often has encryption metadata near file header; find nonce or index at encrypted image header.
# We find enc_image at header; need to skip container metadata (F0->F2), so actual data starts at F3 (decimal 243)
strings -t x v3910_4325.all | grep -i "thunder" # find enc_image truncation location
```



![img](/Image/img_v3910/3910-8.png)

![img](/Image/img_v3910/3910-9.png)

```apl
+-----------------------------+
| ROM Code / BL1 (on-SoC)     |
| -> init hardware, load FIP  |
+-------------â†“---------------+
| tb-fw.bin (Trusted Boot, BL2)|
| -> verify signatures, load soc-fw & nt-fw|
+-------------â†“---------------+
| soc-fw.bin (SoC Firmware, BL31)|
| -> init EL3, switch worlds  |
+-------------â†“---------------+
| nt-fw.bin (Non-Trusted FW, BL33)|
| -> boot U-Boot/Linux, etc.  |
+-----------------------------+
```

~~~apl
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” ARM Trusted Firmware Boot Chain â”‚
â”‚ (Secure â†” Non-Secure World Transition) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

             Power-On / Reset  
                      â”‚  
                      â–¼  


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROM / BootROM (Inside SoC) â”‚
â”‚ â€¢ Minimal boot code executed on power-up â”‚
â”‚ â€¢ Loads BL1 / verifies signatures (Root of Trust) â”‚
â”‚ â€¢ Operates in Secure World (EL3) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL1 (Boot Loader Stage 1) â”‚
â”‚ â€¢ Initializes DRAM, UART, clocks â”‚
â”‚ â€¢ Loads BL2 (FIP Header 0xAA640001) â”‚
â”‚ â€¢ Verifies signatures, establishes chain of trust â”‚
â”‚ â€¢ Secure World â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL2 (Boot Loader Stage 2) â”‚
â”‚ â€¢ Loads tb-fw.bin, soc-fw.bin, nt-fw.bin from FIP â”‚
â”‚ â€¢ Sets up memory mapping, initializes MMU â”‚
â”‚ â€¢ Secure World â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL31 (EL3 Runtime / Secure Monitor) â”‚
â”‚ â€¢ Initializes interrupt controller (GIC) â”‚
â”‚ â€¢ Initializes PSCI (power management) â”‚
â”‚ â€¢ Registers SMC call service interface â”‚
â”‚ â€¢ Launches BL32 (TEE, optional) â”‚
â”‚ â€¢ Secure World (EL3) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚ (Secure Monitor Call communication channel)
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL32 (Optional, Trusted OS / TEE) â”‚
â”‚ â€¢ For example, OP-TEE, Trusty OS â”‚
â”‚ â€¢ Manages keys, encryption services, and other security functions â”‚
â”‚ â€¢ Secure World (EL1S) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”‚
â–¼ ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½
â”‚ â†“ â†“ â†“ â†“ â†“ â†“ â†“ â†“ â†“
â”‚ â†“ World Switch (SMC EXIT) â†“
â”‚ â†“ Secure â†’ Non-Secure â†“
â–¼ ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BL33 = nt-fw.bin â”‚
â”‚ â€¢ Non-Trusted Firmware â”‚
â”‚ â€¢ Typically U-Boot or other OS loader â”‚
â”‚ â€¢ Runs in Non-Secure World (EL2/EL1) â”‚
â”‚ â€¢ Cannot access Secure region â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Operating System (Linux / Android Kernel, etc.) â”‚
â”‚ â€¢ Regular applications and drivers â”‚
â”‚ â€¢ Non-Secure World â”‚
â”‚ â€¢ Can communicate with Secure World via SMC â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸŒ World Partition Summary
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Secure World (Trusted)
- ROM / BL1 / BL2 / BL31 / BL32
- Responsible for signature verification, security services, TEE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Non-Secure World (Untrusted)
- BL33 (nt-fw.bin)
- Standard bootloader or operating system
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
~~~



![img](/Image/img_v3910/3910-10.png)

![img](/Image/img_v3910/3910-11.png)

![img](/Image/img_v3910/3910-14.png)

![img](/Image/img_v3910/3910-15.png)

![img](/Image/img_v3910/3910-13.png)

## 7. Extract the encrypted file

```apl
# Based on the above, begin extraction
dd if=v3910_4325.all of=enc_Image skip=243 bs=1 count=55187968  # extracted file named enc_Image
```



## 8. Construct decryption script

```python
# nonce marker identified as ChaCha20 encryption flag
from Crypto.Cipher import ChaCha20

def do_decrypt(enc_Image):
    nonce = b"UODAjyXZOzH0"

    with open(enc_Image, "rb") as f:
        enc_data = f.read()
    
    key = b"0DraytekKd5Eason3DraytekKd5Eason"    # Why 'Eason'? See the figure below for explanation
    cipher = ChaCha20.new(key=key, nonce=nonce)
    dec_data = cipher.decrypt(enc_data)

    with open(enc_Image + "_decrypted.bin", "wb") as f:
        f.write(dec_data)
    
    print("Done!")

if __name__ == "__main__":
    filename = "enc_Image"
    do_decrypt(filename)
```



![img](/Image/img_v3910/3910-12.png)

## 9. Start decryption

```apl
python3 decrypt_img_4325.py  # start decryption; prints "Done" on success
ls  # see enc_Image_decrypted.bin file
binwalk -Me enc_Image_decrypted.bin  # extraction failed
binwalk -E enc_Image_decrypted.bin  # check entropy; entropy looks messy -> suspect compressed
# Previously we saw 'expand' keyword; messy entropy supports that guess.
binwalk enc_Image_decrypted.bin  # binwalk shows lz4 and gzip; gzip is ASCII type so likely not; lz4 type is 'legacy'
# binwalk reports compressed region at 0x9DFC18 so go to IDA and inspect that address.
# From sub_991C1C analysis we find a decompression function that takes the address and size.
# Now we know compressed offset and size.
# Use dd to extract: offset 10353688, size 0x2A0B6D6 = 44086998 (decimal)
dd if=enc_Image_decrypted.bin of=lz4_expand skip=10353688 bs=1 count=44086998
lz4 -d ./lz4_expand decompressed.bin  # decompress
binwalk -Me decompressed.bin  # extraction success
```



![img](/Image/img_v3910/3910-16.png)

![img](/Image/img_v3910/3910-17.png)

![img](/Image/img_v3910/3910-18.png)

![img](/Image/img_v3910/3910-19.png)

------

# Vulnerability Reproduction

## 1. Inspect startup items and analysis

```apl
# After decrypting firmware, start looking for init scripts
find . \( -name 'rc' -o -name 'rcS' \) -print # search for startup files with keywords rc, rcS, rc.0 etc -> ./sbin/rc
cat ./sbin.rc  # we see it runs run.sh. From rc we know it injects a full firmware/config set into QEMU,
# creates network, serial, shared memory, and other peripherals so the simulated DrayOS receives realistic hardware info.
cat ./firmware/run.sh  # inspect startup script â€” see below
strings ./usr/bin/qemu-system-aarch64 | grep -i draytek  # verify "DrayTek" confirms it's a vendor-modified QEMU
find ./ -name run_linux.sh 2>/dev/null  # locate file -> ./firmware/run_linux.sh in firmware folder; also setup_qemu_linux.sh exists
# Because QEMU is vendor-modified, download corresponding GPL sources from DrayTek's GPL site: https://gplsource.draytek.com/?dir=Vigor3910
# We recompile the vendor's qemu (it was modified), following GPL source instructions.
tar -xvjf new_v3910_v396_GPL_release.tar.bz2  # extract
cd Vigor3910_v396_GPL_release/
cat ReadMe.txt  # read usage
sudo apt-get install liblz4-tool  # install required tool
./bulid  # the README says run ./build; it fails with "Only support X86 64 bit."
# A bold idea: edit 'bulid' script to comment out the check and run again.
nano bulid # find failing check and comment out to bypass; re-run and it proceeds.
ls  # after running, the compiled qemu binary isn't present, but there is a 'source' folder containing qemu-2.12.1.tar.bz2
tar -xvjf qemu-2.12.1.tar.bz2  # extract qemu source
# navigate to: Vigor3910_v396_GPL_release/source/linux/cavium-rootfs/src_dir/qemu-2.12.1 to build qemu-system-aarch64
./configure --enable-kvm --enable-debug --target-list=aarch64-softmmu  # configure
make  # errors: glib-2.22 gthread-2.0 required
sudo apt install libglib2.0-dev  # install missing libs
make  # next error: pixman >= 0.21.8 not present
sudo apt install libpixman-1-dev  # install dependency
make  # compile -> then another error arises during compilation
find ./ -name arm-a64.cc 2>/dev/null  # locate problematic file ./disas/arm-a64.cc
nano ./disas/arm-a64.cc  # edit the file: an extern wasn't referenced correctly; fix it
make clean  # clean build
make  # recompile successfully
cd aarch64-softmmu  # get compiled qemu-system-aarch64 binary, copy it into /_decompressed.bin.extracted/cpio-root/firmware
# Modify run scripts: comment out network reset parts in setup_qemu_linux.sh to avoid accidental resets.
```



![img](/Image/img_v3910/3910fx-1.png)

![img](/Image/img_v3910/3190fx-2.png)

```sh
# Modified run_linux.sh startup script â€” changed real hardware run to virtualized run
#!/bin/bash
# 1. do "fw_setenv purelinux 1" first , then reboot
# 2. do setup_qemu_linux.sh (default P3 as WAN, P4 as LAN, for both 1Gbps connection only)
# 3. remember to recover to normal mode by "fw_setenv purelinux 0"

rangen() {
   printf "%02x"  `shuf -i 1-255 -n 1 `
}


rangen1() {
   printf "%x"  `shuf -i 1-15 -n 1 `
}

wan_mac(){
        idx=$1
        printf "%02x\n" $((0x${C}+0x$idx)) | tail -c 3 # 3 = 2 digit + 1 terminating character
}

A=$(rangen); B=$(rangen); C=$(rangen);
LAN_MAC="00:1d:aa:${A}:${B}:${C}"

if [ ! -p serial0 ]; then
    mkfifo serial0
fi
if [ ! -p serial1 ]; then
    mkfifo serial1
fi

platform_path="./platform"
echo "x86" > $platform_path
enable_kvm_path="./enable_kvm"
echo "kvm" > $enable_kvm_path

cfg_path="./magic_file"

echo "GCI_SKIP" > gci_magic

mkdir -p ../data/uffs
touch ../data/uffs/v3910_ram_flash.bin
uffs_flash="../data/uffs/v3910_ram_flash.bin"

echo "1" > memsize

(sleep 20 && ethtool -K qemu-lan tx off) &

model="./model"
echo "3" > ./model

rm -rf ./app && mkdir -p ./app/gci
GCI_PATH="./app/gci"
GCI_FAIL="./app/gci_exp_fail"
GDEF_FILE="$GCI_PATH/draycfg.def"
GEXP_FLAG="$GCI_PATH/EXP_FLAG"
GEXP_FILE="$GCI_PATH/draycfg.exp"
GDEF_FILE_ADDR="0x4de0000"
GEXP_FLAG_ADDR="0x55e0000"
GEXP_FILE_ADDR="0x55e0010"

echo "0#" > $GEXP_FLAG
echo "19831026" > $GEXP_FILE
echo "GCI_SKIP" > $GDEF_FILE

SHM_SIZE=16777216
./qemu-system-aarch64 -M virt,gic_version=3 -cpu cortex-a57 -m 1024 -L ../usr/share/qemu \
           -kernel ./vqemu/sohod64.bin $serial_option -dtb DrayTek \
           -nographic $gdb_serial_option $gdb_remote_option \
           -device virtio-net-pci,netdev=network-lan,mac=${LAN_MAC} \
           -netdev tap,id=network-lan,ifname=qemu-lan,script=no,downscript=no \
           -device virtio-net-pci,netdev=network-wan,mac=00:1d:aa:${A}:${B}:$(wan_mac 1) \
           -netdev tap,id=network-wan,ifname=qemu-wan,script=no,downscript=no \
           -device virtio-serial-pci -chardev pipe,id=ch0,path=serial0 \
           -device virtserialport,chardev=ch0,name=serial0 \
           -device loader,file=$platform_path,addr=0x25fff0 \
           -device loader,file=$cfg_path,addr=0x260000 \
           -device loader,file=$uffs_flash,addr=0x00be0000 \
           -device loader,file=$enable_kvm_path,addr=0x25ffe0 \
           -device loader,file=memsize,addr=0x25ff67 \
	        -device loader,file=$model,addr=0x25ff69 \
           -device loader,file=$GDEF_FILE,addr=$GDEF_FILE_ADDR \
           -device loader,file=$GEXP_FLAG,addr=$GEXP_FLAG_ADDR \
           -device loader,file=$GEXP_FILE,addr=$GEXP_FILE_ADDR \
           -device nec-usb-xhci,id=usb \
           -device ivshmem-plain,memdev=hostmem \
           -object memory-backend-file,size=${SHM_SIZE},share,mem-path=/dev/shm/ivshmem,id=hostmem
```



## 2. Firmware emulation

```apl
sudo ./setup_qemu_linux.sh  # run network setup script
sudo ./run_linux.sh  # use script to start the simulated environment
```



![img](/Image/img_v3910/3910fx-4.png)

![img](/Image/img_v3910/3910fx-5.png)

## 3. Static analysis

```apl
# When seeing the login page, start Burp and intercept traffic. Try default admin/admin; the front/back interaction still uses cgi for processing.
# We identified wlogin.cgi and found wloginauth.cgi (login auth) locating function sub_40156840. From xrefs, its parent is sub_4015F640 â€” analyze that function next.
```



![img](/Image/img_v3910/3910fx-6.png)

![img](/Image/img_v3910/3910fx-7.png)

## 4. High-level analysis of function `sub_4015F640`

Function signature:

```apl
__int64 __fastcall sub_4015F640(unsigned int a1)
# parameter a1: typically a pointer to the request context structure (HTTP request info, session state, socket, etc.)
# return __int64: return code/result (may represent HTTP status or internal handling code)
```

Overall control flow:

```apl
This function is a core dispatcher.
 It calls sub_40156840((_BYTE *)(a1 + 15916), *(_DWORD *)(a1 + 15608)) and checks its return value (result).
 These result values map to different request types or command codes, for example:
 - 10031, 10085, 10101, 13321, 13322 ...
 - 7001, 6502, 707, 701, 702 ...
 Many appear as CGI identifiers (0x2731 ~ 0x277E), likely mapping device CGI paths to numeric codes.
```



Key functions (call relationships)

| Function name            | Inferred functionality  | Analysis                                                     |
| ------------------------ | ----------------------- | ------------------------------------------------------------ |
| sub_40156840             | CGI command parser      | Parses CGI name or opcode (e.g., `/auth_check.cgi`).         |
| sub_4010E084             | Permission / auth check | Called with "/auth_check.cgi", likely checks login status or auth cookie. |
| sub_40D16D34             | Session / auth check    | Checks if user logged in (true => logged in).                |
| sub_400CF818(code,param) | Response sending        | Sends HTTP/Cgi error or status.                              |
| sub_401590C0             | File/config check       | Checks if config file exists/is valid.                       |
| exec_cgi_script_*        | Executes CGI scripts    | Potential RCE surface.                                       |

| Module            | Function          | Risk                                   |
| ----------------- | ----------------- | -------------------------------------- |
| sub_40156840      | CGI parsing       | Potential overflow / OOB               |
| sub_4010E084      | Auth checking     | Possible bypass                        |
| sub_40D16D34      | Session check     | If controllable, can forge login state |
| sub_400CF818      | Response function | Controls output                        |
| exec_cgi_script_* | Execute commands  | Potential RCE entry                    |

![img](/Image/img_v3910/3910fx-8.png)

```
# While analyzing sub_4015F640 we found "cfg_gci_export_script" as a keyword.
# To reach sub_400FC818(6992,"cfg_gci_export_script"), the prerequisite is sub_401590C0 must return 0.
# Therefore we must analyze sub_4010E084, sub_40D15D34, and sub_401590C0 next.
```

![img](/Image/img_v3910/3910fx-16.png)

```apl
# sub_4010E084 analysis
# From the diagram, to reach return sub_400CF818(6992, "cfg_gci_export_script");
# we need if ((_DWORD)result != -1) to be true.
# Based on the flow, once inside sub_4010E084 it continues and proceeds.
```



![img](/Image/img_v3910/3910fx-19.png)

```apl
# sub_4010CE00 analysis
# At entry, it checks if URL contains "/image/".
# Then v35 is assigned cookie extracted from HTTP.
# v34 is assigned session_id extracted from cookie.
# v33 is assigned computed session_id length.
# First condition: if no valid login cookie AND current path is not public (like /weblogin.htm, cgierr.htm, /images/) AND sub_4010CD68(path) indicates the page requires login -> goto LABEL_116 (302 redirect to login page).
# Second condition: if path is public (/weblogin.htm, /doc/cgierr.htm, /images/) or sub_4010CD68(path) returns false (not protected) -> skip login checks -> LABEL_121 normal completion.
```



![img](/Image/img_v3910/3910fx-23.png)

![img](/Image/img_v3910/3910fx-24.png)

```apl
# sub_40D15D34 analysis
# 1. initialization on entry
# 2. If the form exists, v5 set and function returns !=0 (true)
# 3. If form does not exist, return 0
# Thus when logging in we will construct a form â€” the function returns !=0 and caller continues execution.
```



![img](/Image/img_v3910/3910fx-17.png)

![img](/Image/img_v3910/3910fx-20.png)

```apl
# sub_401590C0 analysis
# From the figure, once entered it returns 0, allowing the subsequent call:
# return sub_400CF818(6992, "cfg_gci_export_script");
```



![img](/Image/img_v3910/3910fx-22.png)

```apl
# To have the whole flow execute, the prerequisite is ( _DWORD)result == 7015
# At entry to sub_4015F640 it first calls dispatch sub_40156840
# We need to find which dispatch path maps to 7015.
# Find string "7015" by searching in sub_40156840 -> we get the dispatch path /Draytek.exp
```



![img](/Image/img_v3910/3910fx-21.png)

Summary:

```apl
# Given the above, to execute "cfg_gci_export_script" we must:
# POST to /Draytek.exp/image/?sFormAuthStr
# The request succeeds but the returned content is garbled -> the response appears encrypted.
```



Verification:

```apl
# Construct request header
POST /Draytek.exp/images/?sFormAuthStr= HTTP/1.1
Host: 192.168.1.1
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 65
```



![img](/Image/img_v3910/3910fx-25.png)

### Decryption phase

```apl
# Search IDA for keyword "encrypt" to locate sub_400CF818
# sub_400CF818 passes encryption config and password to sub_40D1825C for processing.
# Analyze pseudocode: chk_encryptcfg and sEncryptPwd are passed to sub_40D1825C; results stored in v721 array.
# v721 is then processed by sub_40A37D64. Entering sub_40A37D64 we see:
# if ( v47 != 170 && v47 != 187 && v47 != 204 ) ...
# We guess: if chk_encryptcfg != 170, 187, 204 then it's encrypted.
# Further down, if equals 204 it prints a bunch of garbage.
# So in constructed request headers we must set chk_encryptcfg=180 or 187 to avoid garbage.
```



![img](/Image/img_v3910/3910fx-26.png)

![img](/Image/img_v3910/3910fx-27.png)

![img](/Image/img_v3910/3910fx-28.png)

![img](/Image/img_v3910/3910fx-29.png)

### Why determine `sFormAuthStr` is a form and why the auth is form-based â€” a surprising discovery

```apl
# Flow summary:
# Unexpected finding: during authentication we discovered username/password are Base64 encoded.
```



![](/Image/img_v3910/3910fx-15.png)

![](/Image/img_v3910/3910fx-11.png)

![](/Image/img_v3910/3910fx-12.png)

![](/Image/img_v3910/3910fx-13.png)

<img src="/Image/img_v3910/3910fx-14.png" style="zoom:33%;" />
